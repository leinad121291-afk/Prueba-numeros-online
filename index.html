<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N√∫meros Parejas - Juego Local y Online</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Arial', sans-serif;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 800px;
            width: 100%;
        }

        .title {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .phase-title {
            color: #666;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .section-title {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .number-display {
            font-size: 4rem;
            font-weight: bold;
            color: #333;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 3px solid #e9ecef;
        }

        .input-field {
            font-size: 2rem;
            padding: 15px;
            border: 3px solid #ddd;
            border-radius: 10px;
            text-align: center;
            width: 100%;
            max-width: 300px;
            margin: 20px 0;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .small-input {
            font-size: 1rem;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: center;
            width: 80px;
            margin: 0 10px;
        }

        .small-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .digits-input-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }



        .number-pair {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            padding: 10px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            font-family: 'Courier New', monospace;
        }

        .page-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }

        .page-info {
            font-size: 1.1rem;
            color: #666;
            font-weight: bold;
        }

        .digit-input.correct {
            border-color: #28a745;
            background-color: #d4edda;
            color: #155724;
        }

        .digit-input.incorrect {
            border-color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
        }

        .digits-input {
            width: 80px;
            height: 50px;
            border: 3px solid #ddd;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            background: #f8f9fa;
            color: #333;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        /* Estilos para juego online */
        .online-menu {
            background: #e3f2fd;
            border: 2px solid #bbdefb;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }

        .online-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .online-button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .online-button:hover {
            transform: translateY(-2px);
        }

        .join-form {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .room-code-input {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.2rem;
            text-align: center;
            width: 150px;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }

        .waiting-room {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }

        .player-list {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .player-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            min-width: 200px;
            text-align: center;
        }

        .player-item.ready {
            border-color: #28a745;
            background-color: #d4edda;
        }

        .player-item.waiting {
            border-color: #ffc107;
            background-color: #fff3cd;
        }

        .online-game-info {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .opponent-progress {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            width: 0%;
        }

        .online-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .player-results {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .player-results.winner {
            border-color: #28a745;
            background-color: #d4edda;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: bold;
            z-index: 1000;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .digits-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            transform: scale(1.05);
        }

        .digits-input:invalid {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .result-message {
            font-size: 1.5rem;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }

        .correct-result {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .incorrect-result {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .timer {
            font-size: 1.2rem;
            color: #666;
            margin: 10px 0;
        }

        .progress-indicator {
            font-size: 1.1rem;
            color: #666;
            margin: 15px 0;
        }

        .hidden {
            display: none;
        }

        .timer-config {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .timer-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .timer-option label {
            font-size: 1.1rem;
            color: #333;
        }

        .timer-select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: #f8f9fa;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .timer-select:hover {
            background: #e9ecef;
        }
        
        .timer-select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .summary {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #bbdefb;
        }

        .summary h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .summary p {
            margin: 8px 0;
            color: #333;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .mode-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .mode-option label {
            font-size: 1.1rem;
            color: #333;
        }

        .mode-radio {
            margin: 0 5px;
        }

        /* Estilos para la din√°mica de recall */
        .continuous-input-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .continuous-input {
            width: 100%;
            max-width: 400px;
            font-size: 1.5rem;
            padding: 15px;
            border: 3px solid #ddd;
            border-radius: 10px;
            text-align: center;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }

        .continuous-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-hint {
            font-size: 0.9rem;
            color: #666;
            margin: 5px 0;
        }

        .digits-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .digit-input {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            background: white;
            color: #333;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        .digit-input:focus {
            outline: none;
            border-color: #667eea;
            transform: scale(1.05);
        }

        .digit-input.correct {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

                 .digit-input.incorrect {
             background: #f8d7da;
             border-color: #dc3545;
             color: #721c24;
         }
         
         /* Estilos para sistema de rondas */
         .progress-bar {
             width: 100%;
             height: 20px;
             background: #e9ecef;
             border-radius: 10px;
             margin: 15px 0;
             overflow: hidden;
         }
         
         .progress-fill {
             height: 100%;
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             transition: width 0.3s ease;
             width: 0%;
         }
         
         .final-score {
             background: #e3f2fd;
             border-radius: 15px;
             padding: 30px;
             margin: 20px 0;
             border: 2px solid #bbdefb;
             text-align: center;
         }
         
         .score-display {
             font-size: 3rem;
             font-weight: bold;
             margin: 20px 0;
         }
         
         .score-number {
             color: #1976d2;
         }
         
         .score-label {
             color: #666;
             font-size: 1.5rem;
         }
         
         .score-percentage {
             font-size: 2rem;
             color: #28a745;
             font-weight: bold;
         }
         
         .round-breakdown {
             background: #f8f9fa;
             border-radius: 15px;
             padding: 20px;
             margin: 20px 0;
             border: 2px solid #e9ecef;
         }
         
         .rounds-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
             gap: 10px;
             margin: 15px 0;
         }
         
         .round-item {
             padding: 10px;
             border-radius: 8px;
             text-align: center;
             font-weight: bold;
             font-size: 0.9rem;
         }
         
         .round-item.correct {
             background: #d4edda;
             color: #155724;
             border: 2px solid #c3e6cb;
         }
         
         .round-item.incorrect {
             background: #f8d7da;
             color: #721c24;
             border: 2px solid #f5c6cb;
         }
         
         .performance-summary {
             background: #fff3cd;
             border-radius: 15px;
             padding: 20px;
             margin: 20px 0;
             border: 2px solid #ffeaa7;
         }
         
         .performance-summary h4 {
             color: #856404;
             margin-bottom: 15px;
         }
         
         .performance-summary p {
             margin: 8px 0;
             color: #333;
         }

         /* Estilos para progresi√≥n de resultados */
         .rounds-progress-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
             gap: 8px;
             margin: 15px 0;
             max-width: 600px;
             margin-left: auto;
             margin-right: auto;
         }
         
         .progress-round-item {
             width: 40px;
             height: 40px;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             font-weight: bold;
             font-size: 0.9rem;
             border: 2px solid transparent;
             transition: all 0.3s;
         }
         
         .progress-round-item.correct {
             background: #d4edda;
             color: #155724;
             border-color: #c3e6cb;
         }
         
         .progress-round-item.incorrect {
             background: #f8d7da;
             color: #721c24;
             border-color: #f5c6cb;
         }
         
         .progress-round-item.pending {
             background: #e9ecef;
             color: #6c757d;
             border-color: #dee2e6;
         }
         
         .progress-stats {
             background: #f8f9fa;
             border-radius: 10px;
             padding: 15px;
             margin: 15px 0;
             border: 2px solid #e9ecef;
         }
         
         .progress-stats p {
             margin: 8px 0;
             color: #333;
             font-size: 1.1rem;
         }

         /* Estilos para gr√°ficas circulares */
         .chart-container {
             display: flex;
             justify-content: center;
             align-items: center;
             gap: 30px;
             margin: 20px 0;
             flex-wrap: wrap;
         }
         
         .pie-chart {
             position: relative;
             width: 120px;
             height: 120px;
             border-radius: 50%;
             background: conic-gradient(#e9ecef 0deg 360deg);
             display: flex;
             align-items: center;
             justify-content: center;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
         }
         
         .pie-chart::before {
             content: '';
             position: absolute;
             width: 80px;
             height: 80px;
             background: white;
             border-radius: 50%;
             z-index: 1;
         }
         
         .pie-chart-text {
             position: relative;
             z-index: 2;
             font-size: 1.5rem;
             font-weight: bold;
             color: #333;
         }
         
         .chart-label {
             text-align: center;
             font-weight: bold;
             color: #666;
             margin-top: 10px;
             font-size: 0.9rem;
         }
         
         .stats-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
             gap: 20px;
             margin: 20px 0;
         }
         
         .stat-card {
             background: white;
             border-radius: 15px;
             padding: 20px;
             text-align: center;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
             border: 2px solid #e9ecef;
         }
         
         .stat-number {
             font-size: 2.5rem;
             font-weight: bold;
             margin: 10px 0;
         }
         
         .stat-number.correct {
             color: #28a745;
         }
         
         .stat-number.incorrect {
             color: #dc3545;
         }
         
         .stat-number.neutral {
             color: #007bff;
         }
         
         .stat-label {
             color: #666;
             font-size: 1rem;
             margin-bottom: 5px;
         }

         /* Estilos para comparaci√≥n visual */
         .visual-comparison {
             background: #f8f9fa;
             border-radius: 15px;
             padding: 20px;
             margin: 20px 0;
             border: 2px solid #e9ecef;
         }

         .comparison-row {
             display: flex;
             justify-content: center;
             align-items: center;
             gap: 10px;
             margin: 10px 0;
             flex-wrap: wrap;
         }

         .comparison-number {
             display: flex;
             gap: 2px;
             font-family: 'Courier New', monospace;
             font-size: 1.5rem;
             font-weight: bold;
         }

         .comparison-digit {
             width: 30px;
             height: 40px;
             display: flex;
             align-items: center;
             justify-content: center;
             border-radius: 5px;
             border: 2px solid transparent;
         }

         .comparison-digit.correct {
             background: #d4edda;
             color: #155724;
             border-color: #c3e6cb;
         }

         .comparison-digit.incorrect {
             background: #f8d7da;
             color: #721c24;
             border-color: #f5c6cb;
         }

                 .comparison-label {
            font-size: 1rem;
            color: #666;
            font-weight: bold;
            margin: 0 15px;
            min-width: 100px;
            text-align: right;
        }
        
        .fullscreen-button {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fullscreen-button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%) !important;
        }
        
        .fullscreen-button.fullscreen {
            background: linear-gradient(135deg, #8e44ad 0%, #7d3c98 100%) !important;
        }
        
        .fullscreen-button.fullscreen:hover {
            background: linear-gradient(135deg, #7d3c98 0%, #8e44ad 100%) !important;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
            }
            
            .timer-config, .mode-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .number-display {
                font-size: 2rem;
                padding: 20px;
            }

            .digits-grid {
                gap: 10px;
            }

            .digit-input {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .fullscreen-button {
                font-size: 1rem;
                padding: 6px 10px;
                top: 10px;
                right: 10px;
                min-width: 35px;
                min-height: 35px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <button class="fullscreen-button" id="fullscreen-btn" onclick="toggleFullscreen()" title="Pantalla Completa">‚õ∂</button>
        <h1 class="title">N√∫meros Parejas</h1>
        
        <!-- Indicador de conexi√≥n -->
        <div id="connection-status" class="connection-status disconnected hidden">
            Desconectado
        </div>
        
        <!-- Men√∫ Principal -->
        <div id="main-menu">
            <h2 class="phase-title">Selecciona el Modo de Juego</h2>
            
            <div class="online-options">
                <button class="online-button" onclick="showLocalGame()">üéÆ Juego Local</button>
                <button class="online-button" onclick="showOnlineMenu()">üåê Juego Online 1vs1</button>
            </div>
        </div>
        
        <!-- Men√∫ Online -->
        <div id="online-menu" class="hidden">
            <h2 class="phase-title">Juego Online 1vs1</h2>
            
            <div class="online-options">
                <button class="online-button" onclick="createOnlineGame()">üè† Crear Partida</button>
                <button class="online-button" onclick="showJoinForm()">üîó Unirse a Partida</button>
            </div>
            
            <div id="join-form" class="hidden">
                <div class="join-form">
                    <input type="text" id="room-code-input" class="room-code-input" placeholder="C√ìDIGO" maxlength="6" style="text-transform: uppercase;">
                    <button class="online-button" onclick="joinOnlineGame()">Unirse</button>
                </div>
            </div>
            
            <button class="button" onclick="showMainMenu()">‚Üê Volver al Men√∫</button>
        </div>
        
        <!-- Sala de Espera -->
        <div id="waiting-room" class="hidden">
            <div class="waiting-room">
                <h2 class="phase-title">Sala de Espera</h2>
                <h3>C√≥digo de la Sala: <span id="room-code-display" style="font-family: 'Courier New', monospace; color: #007bff;">ABC123</span></h3>
                <p>Comparte este c√≥digo con tu oponente</p>
                
                <div class="player-list">
                    <div class="player-item" id="host-player">
                        <h4>Anfitri√≥n</h4>
                        <p id="host-name">T√∫</p>
                        <span id="host-status">‚úÖ Listo</span>
                    </div>
                    <div class="player-item waiting" id="guest-player">
                        <h4>Invitado</h4>
                        <p id="guest-name">Esperando...</p>
                        <span id="guest-status">‚è≥ Conectando...</span>
                    </div>
                </div>
                
                <button class="button" onclick="leaveOnlineGame()">‚ùå Salir de la Sala</button>
            </div>
        </div>
        
        <!-- Fase de Configuraci√≥n Local -->
        <div id="setup-phase" class="hidden">
            <h2 class="phase-title">Configuraci√≥n del Juego</h2>
            
            <!-- N√∫meros a Memorizar -->
            <div class="section">
                <h3 class="section-title">1. N√∫meros a Memorizar</h3>
                <p>Escribe cu√°ntos n√∫meros quieres memorizar (del 00-99):</p>
                <div class="digits-input-container">
                    <input type="number" id="digits-input" class="digits-input" min="1" max="999999" value="" placeholder="5">
                    <span style="font-size: 1.1rem; color: #333;">n√∫meros</span>
                </div>
                <p id="selected-info">Memorizar√°s 5 n√∫meros del 00-99 (2 n√∫meros por p√°gina)</p>
            </div>

            <!-- Configuraci√≥n de Visualizaci√≥n -->
            <div class="section">
                <h3 class="section-title">2. Configuraci√≥n de Visualizaci√≥n</h3>
                <p>Elige c√≥mo quieres ver los n√∫meros durante la memorizaci√≥n:</p>
                <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; background: white; min-width: 200px;">
                        <input type="radio" id="pairs-mode" name="display-mode" value="pairs" checked>
                        <label for="pairs-mode" style="font-weight: bold; color: #333;">Parejas (2 n√∫meros por p√°gina)</label>
                        <span style="font-size: 0.9rem; color: #666;">(Recomendado)</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; background: white; min-width: 200px;">
                        <input type="radio" id="single-mode" name="display-mode" value="single">
                        <label for="single-mode" style="font-weight: bold; color: #333;">Individual (1 n√∫mero por p√°gina)</label>
                        <span style="font-size: 0.9rem; color: #666;">(M√°s f√°cil)</span>
                    </div>
                </div>
                <p id="display-info" style="font-size: 0.9rem; color: #666; margin-top: 10px;">Ver√°s los n√∫meros en parejas de 2 por p√°gina.</p>
            </div>

            <!-- Configuraci√≥n de Temporizadores -->
            <div class="section">
                <h3 class="section-title">3. Configuraci√≥n de Temporizadores</h3>
                
                <div class="timer-config">
                    <div class="timer-option">
                        <label for="recall-timer">Tiempo para recall (segundos):</label>
                        <input type="number" id="recall-timer" class="timer-select" min="1" max="3600" step="0.1" value="" placeholder="30">
                        <div id="recall-time-conversion" style="font-size: 0.9rem; color: #666; margin-top: 5px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Configuraci√≥n de Rondas -->
            <div class="section">
                <h3 class="section-title">4. Configuraci√≥n de Rondas</h3>
                <p>Elige cu√°ntas rondas quieres jugar:</p>
                <div class="digits-input-container">
                    <input type="number" id="rounds-input" class="digits-input" min="1" max="100" value="" placeholder="10">
                    <span style="font-size: 1.1rem; color: #333;">rondas</span>
                </div>
                <p id="rounds-info">Jugar√°s 10 rondas en total</p>
            </div>

            <!-- Configuraci√≥n de Autoavance -->
            <div class="section">
                <h3 class="section-title">5. Configuraci√≥n de Tiempo de Memorizaci√≥n</h3>
                
                <div class="mode-selector">
                    <div class="mode-option">
                        <input type="radio" id="memorization-mode" name="time-mode" value="memorization" class="mode-radio" checked>
                        <label for="memorization-mode">Tiempo para memorizaci√≥n (segundos):</label>
                        <input type="number" id="memorization-timer" class="timer-select" min="1" max="999999" step="0.1" value="" placeholder="15">
                        <div id="memorization-time-conversion" style="font-size: 0.9rem; color: #666; margin-top: 5px;"></div>
                    </div>
                    
                    <div class="mode-option">
                        <input type="radio" id="auto-advance-mode" name="time-mode" value="auto-advance" class="mode-radio">
                        <label for="auto-advance-mode">Autoavance (segundos):</label>
                        <input type="number" id="auto-advance-time" class="small-input" min="0.1" max="60" step="0.1" value="" placeholder="3">
                    </div>
                </div>
                
                <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                    <span id="mode-description">El juego usar√° el tiempo de memorizaci√≥n configurado.</span>
                </p>
            </div>

            <!-- Resumen de Configuraci√≥n -->
            <div class="summary" id="config-summary">
                <h3>Resumen de Configuraci√≥n</h3>
                <p id="summary-digits">D√≠gitos: 3</p>
                <p id="summary-rounds">Rondas: 10</p>
                <p id="summary-timers">Temporizadores: Memorizaci√≥n 15s, Recall 30s</p>
                <p id="summary-mode">Modo: Tiempo de memorizaci√≥n</p>
            </div>
            
            <button class="button" onclick="startGame()">Comenzar Juego</button>
        </div>

        <!-- Fase de Memorizaci√≥n -->
        <div id="memorization-phase" class="hidden">
            <h2 class="phase-title">Fase de Memorizaci√≥n</h2>
            <div class="timer" id="timer">Tiempo restante: 15 segundos</div>
            <div class="timer" id="elapsed-time" style="color: #1976d2; font-weight: bold;">Tiempo empleado: 0.0 segundos</div>
            <div class="number-display" id="number-display"></div>
            <div class="progress-indicator" id="progress">N√∫meros 1-2 de 5</div>
            <div style="margin: 20px 0;">
                <button class="button" id="prev-btn" onclick="previousNumber()" disabled>‚Üê Anterior</button>
                <button class="button" id="next-btn" onclick="nextNumber()">Siguiente ‚Üí</button>
            </div>
            <p id="memorization-info">Memoriza estos n√∫meros. Tienes 15 segundos.</p>
            <div style="margin: 30px 0;">
                <button class="button" id="finish-memorization-btn" onclick="finishMemorization()">Terminar Memorizaci√≥n</button>
            </div>
        </div>

        <!-- Fase de Escritura -->
        <div id="input-phase" class="hidden">
            <h2 class="phase-title">Escribe los N√∫meros</h2>
            <div class="timer" id="recall-timer-display">Tiempo restante: 30 segundos</div>
            <p>Escribe los n√∫meros de forma continua usando el teclado, o haz clic en cualquier d√≠gito para editarlo directamente:</p>
            <p style="color: #007bff; font-weight: bold;">üí° Tip: Usa las flechas ‚Üê ‚Üí del teclado para navegar entre d√≠gitos</p>
            
            <!-- Input continuo para escritura r√°pida -->
            <div class="continuous-input-container">
                <label for="continuous-input">Escritura continua (recomendado):</label>
                <input type="text" id="continuous-input" class="continuous-input" placeholder="Escribe todos los n√∫meros seguidos aqu√≠..." maxlength="999">
                <p class="input-hint">Simplemente escribe los n√∫meros y se distribuir√°n autom√°ticamente. Tambi√©n puedes hacer clic en cualquier d√≠gito para editarlo directamente.</p>
                <p class="input-hint" style="color: #007bff; font-weight: bold;">üí° Tip: Puedes escribir directamente sin hacer clic en ning√∫n lugar. Solo presiona las teclas num√©ricas y se llenar√°n autom√°ticamente. Tambi√©n puedes hacer clic en cualquier d√≠gito para editarlo directamente.</p>
            </div>
            
            <div id="digits-input-container" class="digits-grid"></div>
            <div>
                <button class="button" onclick="checkAnswer()" id="verify-btn">Verificar Respuesta</button>
                <button class="button" onclick="showNumberAgain()" id="show-again-btn">Ver de Nuevo</button>
            </div>
        </div>

                 <!-- Fase de Resultado -->
         <div id="result-phase" class="hidden">
             <h2 class="phase-title">Resultado Ronda <span id="current-round-display">1</span></h2>
             <div id="result-message"></div>
             
             <!-- Resultado de la Ronda Actual -->
             <div class="section">
                 <h3 class="section-title">Resultado Ronda <span id="current-round-number">1</span></h3>
                 
                 <!-- Estad√≠sticas de la ronda -->
                 <div class="stats-grid" id="round-stats-grid">
                     <div class="stat-card">
                         <div class="stat-label">Porcentaje de Acierto</div>
                         <div class="stat-number neutral" id="round-accuracy">0%</div>
                         <div style="font-size: 0.9rem; color: #666;">d√≠gitos correctos</div>
                     </div>
                     <div class="stat-card">
                         <div class="stat-label">Estado</div>
                         <div class="stat-number neutral" id="round-status">Pendiente</div>
                         <div style="font-size: 0.9rem; color: #666;">de la ronda</div>
                     </div>
                 </div>
             </div>
             
             <!-- Comparaci√≥n visual de resultados -->
             <div id="visual-comparison-container" class="visual-comparison"></div>
             
             <!-- Progresi√≥n de Rondas -->
             <div class="section">
                 <h3 class="section-title">Progresi√≥n de Rondas</h3>
                 
                 <!-- Lista simple de porcentajes por ronda -->
                 <div id="rounds-percentage-list" style="margin: 20px 0; text-align: center;">
                     <!-- Aqu√≠ se mostrar√°n los porcentajes de cada ronda -->
                 </div>
                 
                 <!-- Estad√≠sticas totales -->
                 <div class="stats-grid" id="progress-stats-grid">
                     <div class="stat-card">
                         <div class="stat-label">Rondas Correctas</div>
                         <div class="stat-number neutral" id="current-score">0</div>
                         <div style="font-size: 0.9rem; color: #666;">de <span id="current-round">1</span></div>
                     </div>
                     <div class="stat-card">
                         <div class="stat-label">Promedio Precisi√≥n</div>
                         <div class="stat-number neutral" id="current-percentage">0%</div>
                         <div style="font-size: 0.9rem; color: #666;">de d√≠gitos correctos</div>
                     </div>
                     <div class="stat-card">
                         <div class="stat-label">Mejor Racha</div>
                         <div class="stat-number neutral" id="current-streak">0</div>
                         <div style="font-size: 0.9rem; color: #666;">consecutivas</div>
                     </div>
                 </div>
             </div>
             
             <!-- Configuraci√≥n de tiempo para siguiente ronda -->
             <div class="section">
                 <h3 class="section-title">Configuraci√≥n para Siguiente Ronda</h3>
                 
                 <div class="mode-selector">
                     <div class="mode-option">
                         <input type="radio" id="result-memorization-mode" name="result-time-mode" value="memorization" class="mode-radio" checked>
                         <label for="result-memorization-mode">Tiempo para memorizaci√≥n (segundos):</label>
                         <input type="number" id="result-memorization-timer" class="timer-select" min="1" max="999999" step="0.1" value="" placeholder="15">
                         <div id="result-memorization-time-conversion" style="font-size: 0.9rem; color: #666; margin-top: 5px;"></div>
                     </div>
                     
                     <div class="mode-option">
                         <input type="radio" id="result-auto-advance-mode" name="result-time-mode" value="auto-advance" class="mode-radio">
                         <label for="result-auto-advance-mode">Autoavance (segundos):</label>
                         <input type="number" id="result-auto-advance-time" class="small-input" min="0.1" max="60" step="0.1" value="" placeholder="3">
                     </div>
                 </div>
                 
                 <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                     <span id="result-mode-description">El juego usar√° el tiempo de memorizaci√≥n configurado.</span>
                 </p>
             </div>
             
             <div id="round-progress">
                 <p>Ronda <span id="round-number">1</span> de <span id="total-rounds">10</span></p>
                 <div class="progress-bar">
                     <div class="progress-fill" id="round-progress-fill"></div>
                 </div>
             </div>
             <div>
                 <button class="button" onclick="nextRound()" id="next-round-btn">Siguiente Ronda</button>
                 <button class="button" onclick="resetGame()" id="new-game-btn">Nuevo Juego</button>
                 <button class="button" onclick="goToMenu()" id="menu-btn" style="display: none;">Men√∫</button>
             </div>
         </div>
         
         <!-- Fase de Resultados Finales -->
         <div id="final-results-phase" class="hidden">
             <h2 class="phase-title">¬°Juego Completado!</h2>
             
             <!-- Gr√°ficas circulares principales -->
             <div class="chart-container">
                 <div>
                     <div class="pie-chart" id="final-accuracy-chart">
                         <div class="pie-chart-text">0%</div>
                     </div>
                     <div class="chart-label">Precisi√≥n Final</div>
                 </div>
                 <div>
                     <div class="pie-chart" id="final-score-chart">
                         <div class="pie-chart-text">0/10</div>
                     </div>
                     <div class="chart-label">Progreso</div>
                 </div>
                 <div>
                     <div class="pie-chart" id="final-streak-chart">
                         <div class="pie-chart-text">0</div>
                     </div>
                     <div class="chart-label">Mejor Racha</div>
                 </div>
             </div>
             
             <!-- Estad√≠sticas finales detalladas -->
             <div class="stats-grid">
                 <div class="stat-card">
                     <div class="stat-label">Puntuaci√≥n Total</div>
                     <div class="stat-number neutral" id="final-total-score">0</div>
                     <div style="font-size: 0.9rem; color: #666;">de <span id="final-total-rounds">10</span></div>
                 </div>
                 <div class="stat-card">
                     <div class="stat-label">Porcentaje Final</div>
                     <div class="stat-number neutral" id="final-score-percentage">0%</div>
                     <div style="font-size: 0.9rem; color: #666;">de acierto</div>
                 </div>
                 <div class="stat-card">
                     <div class="stat-label">Rondas Correctas</div>
                     <div class="stat-number correct" id="final-correct-rounds">0</div>
                     <div style="font-size: 0.9rem; color: #666;">de <span id="final-total-rounds-2">10</span></div>
                 </div>
                 <div class="stat-card">
                     <div class="stat-label">Mejor Racha</div>
                     <div class="stat-number neutral" id="final-best-streak">0</div>
                     <div style="font-size: 0.9rem; color: #666;">consecutivas</div>
                 </div>
             </div>
             
             <!-- Progresi√≥n visual completa -->
             <div class="round-breakdown">
                 <h4>Progresi√≥n Completa:</h4>
                 <div class="rounds-grid" id="final-rounds-breakdown"></div>
             </div>
             
             <!-- Resumen de rendimiento -->
             <div class="performance-summary">
                 <h4>An√°lisis de Rendimiento:</h4>
                 <div id="final-performance-stats"></div>
             </div>
             
             <div>
                 <button class="button" onclick="resetGame()">Jugar de Nuevo</button>
             </div>
         </div>
         
         <!-- Fases Online -->
         
         <!-- Fase de Configuraci√≥n Online -->
         <div id="online-setup-phase" class="hidden">
             <h2 class="phase-title">Configuraci√≥n de la Partida Online</h2>
             
             <div class="online-game-info">
                 <h3>C√≥digo de Sala: <span id="online-room-code" style="font-family: 'Courier New', monospace; color: #007bff;"></span></h3>
                 <p id="online-setup-status">Esperando configuraci√≥n del anfitri√≥n...</p>
             </div>
             
             <div id="online-config-display" class="section">
                 <h3 class="section-title">Configuraci√≥n de la Partida</h3>
                 <div id="online-config-details">
                     <!-- Se mostrar√° la configuraci√≥n aqu√≠ -->
                 </div>
             </div>
             
             <div id="online-ready-section" class="section">
                 <h3 class="section-title">Estado de los Jugadores</h3>
                 <div class="player-list">
                     <div class="player-item" id="online-host-player">
                         <h4>Anfitri√≥n</h4>
                         <p id="online-host-name">Anfitri√≥n</p>
                         <span id="online-host-ready">‚è≥ Configurando...</span>
                     </div>
                     <div class="player-item" id="online-guest-player">
                         <h4>Invitado</h4>
                         <p id="online-guest-name">Invitado</p>
                         <span id="online-guest-ready">‚è≥ Esperando...</span>
                     </div>
                 </div>
             </div>
             
             <button class="button" id="online-ready-btn" onclick="setPlayerReady()" disabled>Listo para Jugar</button>
             <button class="button" onclick="leaveOnlineGame()">‚ùå Salir de la Partida</button>
         </div>
         
         <!-- Fase de Memorizaci√≥n Online -->
         <div id="online-memorization-phase" class="hidden">
             <h2 class="phase-title">Fase de Memorizaci√≥n - Ronda <span id="online-current-round">1</span></h2>
             
             <div class="online-game-info">
                 <h3>C√≥digo de Sala: <span id="online-mem-room-code" style="font-family: 'Courier New', monospace; color: #007bff;"></span></h3>
             </div>
             
             <div class="timer" id="online-timer">Tiempo restante: 15 segundos</div>
             <div class="timer" id="online-elapsed-time" style="color: #1976d2; font-weight: bold;">Tiempo empleado: 0.0 segundos</div>
             
             <div class="number-display" id="online-number-display">00</div>
             <div class="progress-indicator" id="online-progress">N√∫mero 1 de 5</div>
             
             <div class="opponent-progress">
                 <h4>Progreso del Oponente</h4>
                 <div class="progress-bar">
                     <div class="progress-fill" id="opponent-progress-fill"></div>
                 </div>
                 <p id="opponent-status">El oponente est√° memorizando...</p>
             </div>
             
             <div class="page-navigation">
                 <button class="button" id="online-prev-btn" onclick="onlinePreviousNumber()" disabled>‚Üê Anterior</button>
                 <span class="page-info" id="online-page-info">P√°gina 1 de 3</span>
                 <button class="button" id="online-next-btn" onclick="onlineNextNumber()">Siguiente ‚Üí</button>
             </div>
             
             <p id="online-memorization-info">Memoriza estos n√∫meros. Tienes 15 segundos.</p>
         </div>
         
         <!-- Fase de Escritura Online -->
         <div id="online-input-phase" class="hidden">
             <h2 class="phase-title">Escribe los N√∫meros - Ronda <span id="online-input-round">1</span></h2>
             
             <div class="online-game-info">
                 <h3>C√≥digo de Sala: <span id="online-input-room-code" style="font-family: 'Courier New', monospace; color: #007bff;"></span></h3>
             </div>
             
             <div class="timer" id="online-recall-timer-display">Tiempo restante: 30 segundos</div>
             <p>Escribe los n√∫meros que memorizaste:</p>
             
             <div id="online-digits-input-container" class="digits-input-container"></div>
             
             <div class="opponent-progress">
                 <h4>Estado del Oponente</h4>
                 <p id="opponent-writing-status">El oponente est√° escribiendo...</p>
             </div>
             
             <div>
                 <button class="button" onclick="onlineCheckAnswer()" id="online-verify-btn">Verificar Respuesta</button>
             </div>
         </div>
         
         <!-- Fase de Resultados Online -->
         <div id="online-result-phase" class="hidden">
             <h2 class="phase-title">Resultados Ronda <span id="online-result-round">1</span></h2>
             
             <div class="online-game-info">
                 <h3>C√≥digo de Sala: <span id="online-result-room-code" style="font-family: 'Courier New', monospace; color: #007bff;"></span></h3>
             </div>
             
             <div class="online-results">
                 <div class="player-results" id="player1-results">
                     <h3>Tu Resultado</h3>
                     <div id="player1-accuracy">0%</div>
                     <div id="player1-time">0.0s</div>
                     <div id="player1-status">Pendiente</div>
                 </div>
                 <div class="player-results" id="player2-results">
                     <h3>Resultado del Oponente</h3>
                     <div id="player2-accuracy">0%</div>
                     <div id="player2-time">0.0s</div>
                     <div id="player2-status">Pendiente</div>
                 </div>
             </div>
             
             <div class="section">
                 <h3 class="section-title">Comparaci√≥n de N√∫meros</h3>
                 <div id="online-comparison-grid"></div>
             </div>
             
             <div class="section">
                 <h3 class="section-title">Progreso de la Partida</h3>
                 <div id="online-rounds-progress"></div>
             </div>
             
             <div id="online-round-progress">
                 <p>Ronda <span id="online-round-number">1</span> de <span id="online-total-rounds">10</span></p>
                 <div style="width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; margin: 15px 0; overflow: hidden;">
                     <div style="height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease; width: 0%;" id="online-round-progress-fill"></div>
                 </div>
             </div>
             
             <div>
                 <button class="button" id="online-next-round-btn" onclick="onlineNextRound()" style="display: none;">Siguiente Ronda</button>
                 <button class="button" onclick="leaveOnlineGame()">‚ùå Salir de la Partida</button>
             </div>
         </div>
         
         <!-- Fase de Resultados Finales Online -->
         <div id="online-final-results-phase" class="hidden">
             <h2 class="phase-title">¬°Partida Completada!</h2>
             
             <div class="online-game-info">
                 <h3>C√≥digo de Sala: <span id="online-final-room-code" style="font-family: 'Courier New', monospace; color: #007bff;"></span></h3>
             </div>
             
             <div class="online-results">
                 <div class="player-results" id="final-player1-results">
                     <h3>Tu Resultado Final</h3>
                     <div id="final-player1-score">0/10</div>
                     <div id="final-player1-accuracy">0%</div>
                     <div id="final-player1-status">Pendiente</div>
                 </div>
                 <div class="player-results" id="final-player2-results">
                     <h3>Resultado Final del Oponente</h3>
                     <div id="final-player2-score">0/10</div>
                     <div id="final-player2-accuracy">0%</div>
                     <div id="final-player2-status">Pendiente</div>
                 </div>
             </div>
             
             <div class="section">
                 <h3 class="section-title">Ganador de la Partida</h3>
                 <div id="online-winner-announcement" style="text-align: center; font-size: 2rem; font-weight: bold; margin: 20px 0;">
                     <!-- Se mostrar√° el ganador aqu√≠ -->
                 </div>
             </div>
             
             <div class="section">
                 <h3 class="section-title">Estad√≠sticas de la Partida</h3>
                 <div id="online-final-stats"></div>
             </div>
             
             <div>
                 <button class="button" onclick="createOnlineGame()">üè† Nueva Partida</button>
                 <button class="button" onclick="showMainMenu()">üè† Men√∫ Principal</button>
             </div>
         </div>
    </div>

    <script>
        let gameState = 'setup';
        let selectedDigits = 5;
        let numberSequence = [];
        let currentNumberIndex = 0;
        let userInput = '';
        let isCorrect = null;
        let timer = 0;
        let memorizationTime = 15;
        let recallTime = 30;
        let timerInterval;
        let recallTimerInterval;
        let memorizationStartTime = 0;
        let actualMemorizationTime = 0;
        
        // Variables para autoavance
        let autoAdvanceEnabled = false;
        let autoAdvanceTime = 3;
        let autoAdvanceTimer = 0;
        let autoAdvanceInterval;
        let currentMode = 'memorization'; // 'memorization' o 'auto-advance'
        let displayMode = 'pairs'; // 'pairs' o 'single'
        let results = []; // Para almacenar resultados detallados
        
        // Variables para sistema de rondas
        let currentRound = 1;
        let totalRounds = 10;
        let roundScores = []; // Array para almacenar puntuaciones de cada ronda
        let totalScore = 0;
        
        // Variables para juego online
        let isOnlineGame = false;
        let roomCode = '';
        let playerId = '';
        let isHost = false;
        let opponentId = '';
        let onlineGameState = 'waiting'; // waiting, setup, memorizing, writing, results, finished
        let onlineConfig = null;
        let onlineNumberSequence = [];
        let onlineCurrentNumberIndex = 0;
        let onlineTimer = 0;
        let onlineTimerInterval;
        let onlineRecallTimerInterval;
        let onlineMemorizationStartTime = 0;
        let onlineActualMemorizationTime = 0;
        let onlineRoundScores = [];
        let onlineTotalScore = 0;
        let onlineCurrentRound = 1;
        let onlineTotalRounds = 10;
        let onlinePlayerReady = false;
        let onlineOpponentReady = false;
        let onlinePlayerResults = [];
        let onlineOpponentResults = [];
        
        // Simulaci√≥n de Firebase para desarrollo (usando localStorage)
        let db = {
            ref: function(path) {
                return {
                    child: function(childPath) {
                        return this;
                    },
                    set: function(data) {
                        localStorage.setItem('firebase_' + path, JSON.stringify(data));
                    },
                    update: function(data) {
                        const existing = JSON.parse(localStorage.getItem('firebase_' + path) || '{}');
                        const updated = {...existing, ...data};
                        localStorage.setItem('firebase_' + path, JSON.stringify(updated));
                    },
                    remove: function() {
                        localStorage.removeItem('firebase_' + path);
                    },
                    once: function(event) {
                        return Promise.resolve({
                            exists: function() {
                                return localStorage.getItem('firebase_' + path) !== null;
                            },
                            val: function() {
                                return JSON.parse(localStorage.getItem('firebase_' + path) || '{}');
                            }
                        });
                    },
                    on: function(event, callback) {
                        // Simular eventos con polling
                        const interval = setInterval(() => {
                            const data = JSON.parse(localStorage.getItem('firebase_' + path) || '{}');
                            callback({exists: () => Object.keys(data).length > 0, val: () => data});
                        }, 1000);
                        
                        // Guardar el intervalo para poder limpiarlo
                        this.off = function() {
                            clearInterval(interval);
                        };
                    },
                    off: function() {}
                };
            }
        };
        
        let roomRef;
        let playerRef;

        // Generar secuencia de n√∫meros del 00-99
        function generateNumberSequence() {
            numberSequence = [];
            for (let i = 0; i < selectedDigits; i++) {
                const number = Math.floor(Math.random() * 100);
                numberSequence.push(number.toString().padStart(2, '0'));
            }
        }

        // Configurar entrada de n√∫meros a memorizar
        document.getElementById('digits-input').addEventListener('input', function() {
            // Si el usuario est√° borrando, permitir que el campo est√© vac√≠o temporalmente
            if (this.value === '') {
                selectedDigits = 0;
                document.getElementById('selected-info').textContent = 'Escribe cu√°ntos n√∫meros quieres memorizar';
                updateSummary();
                updateModeDescription();
                return;
            }
            
            selectedDigits = parseInt(this.value) || 0;
            if (selectedDigits < 1) selectedDigits = 1;
            if (selectedDigits > 999999) selectedDigits = 999999;
            this.value = selectedDigits;
            
            const pages = Math.ceil(selectedDigits / 2);
            document.getElementById('selected-info').textContent = `Memorizar√°s ${selectedDigits} n√∫meros del 00-99 (${pages} p√°ginas)`;
            updateSummary();
            updateModeDescription();
            updateDisplayInfo();
        });
        
        // Establecer valor por defecto solo cuando el campo est√© vac√≠o y el usuario haya terminado de escribir
        document.getElementById('digits-input').addEventListener('blur', function() {
            if (!this.value || this.value === '') {
                this.value = '5';
                selectedDigits = 5;
                const pages = Math.ceil(selectedDigits / 2);
                document.getElementById('selected-info').textContent = `Memorizar√°s ${selectedDigits} n√∫meros del 00-99 (${pages} p√°ginas)`;
                updateSummary();
                updateModeDescription();
                updateDisplayInfo();
            }
        });

        // Configurar entrada de n√∫mero de rondas
        document.getElementById('rounds-input').addEventListener('input', function() {
            // Si el usuario est√° borrando, permitir que el campo est√© vac√≠o temporalmente
            if (this.value === '') {
                totalRounds = 0;
                document.getElementById('rounds-info').textContent = 'Escribe cu√°ntas rondas quieres jugar';
                updateSummary();
                return;
            }
            
            totalRounds = parseInt(this.value) || 0;
            if (totalRounds < 1) totalRounds = 1;
            if (totalRounds > 100) totalRounds = 100;
            this.value = totalRounds;
            
            document.getElementById('rounds-info').textContent = `Jugar√°s ${totalRounds} rondas en total`;
            updateSummary();
        });
        
        // Establecer valor por defecto para rondas
        document.getElementById('rounds-input').addEventListener('blur', function() {
            if (!this.value || this.value === '') {
                this.value = '10';
                totalRounds = 10;
                document.getElementById('rounds-info').textContent = `Jugar√°s ${totalRounds} rondas en total`;
                updateSummary();
            }
        });

        // Funci√≥n para convertir segundos a minutos y segundos
        function formatTimeDisplay(seconds) {
            if (seconds < 60) {
                return `${seconds} segundos`;
            } else {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.round(seconds % 60);
                if (remainingSeconds === 0) {
                    return `${minutes} minuto${minutes > 1 ? 's' : ''}`;
                } else {
                    return `${minutes} minuto${minutes > 1 ? 's' : ''} y ${remainingSeconds} segundo${remainingSeconds > 1 ? 's' : ''}`;
                }
            }
        }

        // Configurar temporizadores (estos event listeners se manejan en DOMContentLoaded)

        // Configurar modo de tiempo
        document.getElementById('memorization-mode').addEventListener('change', function() {
            if (this.checked) {
                currentMode = 'memorization';
                autoAdvanceEnabled = false;
                updateModeDescription();
                updateSummary();
                
                // Mostrar bot√≥n "Ver de Nuevo"
                document.getElementById('show-again-btn').style.display = 'inline-block';
            }
        });

        document.getElementById('auto-advance-mode').addEventListener('change', function() {
            if (this.checked) {
                currentMode = 'auto-advance';
                autoAdvanceEnabled = true;
                updateModeDescription();
                updateSummary();
                
                // Ocultar bot√≥n "Ver de Nuevo"
                document.getElementById('show-again-btn').style.display = 'none';
            }
        });

        // Configurar tiempo de autoavance
        document.getElementById('auto-advance-time').addEventListener('input', function() {
            autoAdvanceTime = parseFloat(this.value) || 3;
            updateSummary();
            updateModeDescription();
        });
        
        // Event listeners para modo de visualizaci√≥n
        document.getElementById('pairs-mode').addEventListener('change', function() {
            if (this.checked) {
                displayMode = 'pairs';
                updateDisplayInfo();
                updateSummary();
            }
        });
        
        document.getElementById('single-mode').addEventListener('change', function() {
            if (this.checked) {
                displayMode = 'single';
                updateDisplayInfo();
                updateSummary();
            }
        });

        // Actualizar descripci√≥n del modo
        function updateModeDescription() {
            const description = document.getElementById('mode-description');
            if (currentMode === 'memorization') {
                if (memorizationTime > 0) {
                    description.textContent = `El juego usar√° el tiempo de memorizaci√≥n configurado (${memorizationTime.toFixed(1)} segundos).`;
                } else {
                    description.textContent = `El juego usar√° el tiempo de memorizaci√≥n configurado (escribe un tiempo).`;
                }
            } else {
                const pages = displayMode === 'pairs' ? Math.ceil(selectedDigits / 2) : selectedDigits;
                if (autoAdvanceTime > 0) {
                    const totalTime = pages * autoAdvanceTime;
                    description.textContent = `El juego avanzar√° autom√°ticamente cada ${autoAdvanceTime.toFixed(1)} segundos por p√°gina (${totalTime.toFixed(1)} segundos total).`;
                } else {
                    description.textContent = `El juego avanzar√° autom√°ticamente cada (escribe tiempo) segundos por p√°gina.`;
                }
            }
        }
        
        // Actualizar informaci√≥n de visualizaci√≥n
        function updateDisplayInfo() {
            const displayInfo = document.getElementById('display-info');
            const selectedInfo = document.getElementById('selected-info');
            
            if (displayMode === 'pairs') {
                const pages = Math.ceil(selectedDigits / 2);
                displayInfo.textContent = `Ver√°s los n√∫meros en parejas de 2 por p√°gina (${pages} p√°ginas).`;
                selectedInfo.textContent = `Memorizar√°s ${selectedDigits} n√∫meros del 00-99 (2 n√∫meros por p√°gina)`;
            } else {
                displayInfo.textContent = `Ver√°s los n√∫meros uno por uno (${selectedDigits} p√°ginas).`;
                selectedInfo.textContent = `Memorizar√°s ${selectedDigits} n√∫meros del 00-99 (1 n√∫mero por p√°gina)`;
            }
        }

        // Actualizar resumen
        function updateSummary() {
            const pages = displayMode === 'pairs' ? Math.ceil(selectedDigits / 2) : selectedDigits;
            if (selectedDigits > 0) {
                const displayText = displayMode === 'pairs' ? 'parejas' : 'individual';
                document.getElementById('summary-digits').textContent = `N√∫meros: ${selectedDigits} (${pages} p√°ginas, modo ${displayText})`;
            } else {
                document.getElementById('summary-digits').textContent = `N√∫meros: (escribe un n√∫mero)`;
            }
            
            // Actualizar informaci√≥n de rondas
            if (totalRounds > 0) {
                document.getElementById('summary-rounds').textContent = `Rondas: ${totalRounds}`;
            } else {
                document.getElementById('summary-rounds').textContent = `Rondas: (escribe un n√∫mero)`;
            }
            
            // Manejar temporizadores vac√≠os
            const memorizationText = memorizationTime > 0 ? `${memorizationTime.toFixed(1)}s` : '(escribe tiempo)';
            const recallText = recallTime > 0 ? `${recallTime.toFixed(1)}s` : '(escribe tiempo)';
            document.getElementById('summary-timers').textContent = `Temporizadores: Memorizaci√≥n ${memorizationText}, Recall ${recallText}`;
            
            if (currentMode === 'memorization') {
                const modeText = memorizationTime > 0 ? `(${memorizationTime.toFixed(1)}s)` : '(escribe tiempo)';
                document.getElementById('summary-mode').textContent = `Modo: Tiempo de memorizaci√≥n ${modeText}`;
            } else {
                const autoAdvanceText = autoAdvanceTime > 0 ? `${autoAdvanceTime.toFixed(1)}s` : '(escribe tiempo)';
                const totalTime = pages * autoAdvanceTime;
                const totalText = totalTime > 0 ? `${totalTime.toFixed(1)}s` : '(calculando...)';
                document.getElementById('summary-mode').textContent = `Modo: Autoavance (${autoAdvanceText} por p√°gina, ${totalText} total)`;
            }
        }

        // Inicializar resumen y descripci√≥n
        updateSummary();
        updateModeDescription();
        updateDisplayInfo();
        
        // Inicializar conversi√≥n de tiempo de recall
        const recallConversion = document.getElementById('recall-time-conversion');
        if (recallTime > 60) {
            recallConversion.textContent = `(${formatTimeDisplay(recallTime)})`;
            recallConversion.style.display = 'block';
        }
        
        // Inicializar conversi√≥n de tiempo de memorizaci√≥n
        const memorizationConversion = document.getElementById('memorization-time-conversion');
        if (memorizationTime > 60) {
            memorizationConversion.textContent = `(${formatTimeDisplay(memorizationTime)})`;
            memorizationConversion.style.display = 'block';
        }

                 // Iniciar juego
         function startGame() {
             // Validar que el campo de n√∫meros no est√© vac√≠o
             if (selectedDigits <= 0) {
                 alert('Por favor, escribe cu√°ntos n√∫meros quieres memorizar antes de comenzar el juego.');
                 document.getElementById('digits-input').focus();
                 return;
             }
             
             // Validar que el campo de rondas no est√© vac√≠o
             if (totalRounds <= 0) {
                 alert('Por favor, escribe cu√°ntas rondas quieres jugar antes de comenzar el juego.');
                 document.getElementById('rounds-input').focus();
                 return;
             }
             
             // Validar que los campos de tiempo no est√©n vac√≠os
             if (currentMode === 'memorization') {
                 if (memorizationTime <= 0) {
                     alert('Por favor, escribe el tiempo de memorizaci√≥n antes de comenzar el juego.');
                     document.getElementById('memorization-timer').focus();
                     return;
                 }
             } else {
                 if (autoAdvanceTime <= 0) {
                     alert('Por favor, escribe el tiempo de autoavance antes de comenzar el juego.');
                     document.getElementById('auto-advance-time').focus();
                     return;
                 }
             }
             
             if (recallTime <= 0) {
                 alert('Por favor, escribe el tiempo de recall antes de comenzar el juego.');
                 document.getElementById('recall-timer').focus();
                 return;
             }
             
             // Reiniciar variables de rondas al iniciar nuevo juego
             currentRound = 1;
             roundScores = [];
             totalScore = 0;
             
             // Obtener modo de visualizaci√≥n seleccionado
             const pairsMode = document.getElementById('pairs-mode');
             const singleMode = document.getElementById('single-mode');
             if (pairsMode.checked) {
                 displayMode = 'pairs';
             } else if (singleMode.checked) {
                 displayMode = 'single';
             }
             
             generateNumberSequence();
             currentNumberIndex = 0;
             gameState = 'memorization';
             
                           // Usar tiempo seg√∫n el modo seleccionado
              if (currentMode === 'auto-advance') {
                  timer = autoAdvanceTime;
              } else {
                  timer = memorizationTime;
              }
              
              // Limpiar todos los campos antes de iniciar
              clearAllInputs();
              
              document.getElementById('setup-phase').classList.add('hidden');
              document.getElementById('memorization-phase').classList.remove('hidden');
              
              updateDisplay();
              
              // Actualizar timer inicial
              document.getElementById('timer').textContent = `Tiempo restante: ${timer.toFixed(1)} segundos`;
              
                           // Actualizar mensaje de memorizaci√≥n
             const memorizationInfo = document.getElementById('memorization-info');
             if (currentMode === 'auto-advance') {
                 const totalPages = displayMode === 'pairs' ? Math.ceil(numberSequence.length / 2) : numberSequence.length;
                 memorizationInfo.textContent = `Ronda ${currentRound} - P√°gina 1 de ${totalPages}. Avanzar√° autom√°ticamente en ${autoAdvanceTime.toFixed(1)} segundos.`;
             } else {
                 memorizationInfo.textContent = `Ronda ${currentRound} - Memoriza estos n√∫meros. Tienes ${memorizationTime.toFixed(1)} segundos.`;
             }
             
             // Configurar captura global de teclas para memorizaci√≥n
             window.cleanupKeyCapture = setupGlobalKeyCapture();
             
             memorizationStartTime = Date.now();
             startTimer();
         }

        // Actualizar pantalla de memorizaci√≥n
        function updateDisplay() {
            console.log('=== FUNCI√ìN updateDisplay() EJECUTADA ===');
            
            const display = document.getElementById('number-display');
            const progress = document.getElementById('progress');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            console.log('Elementos encontrados:', {
                display: !!display,
                progress: !!progress,
                prevBtn: !!prevBtn,
                nextBtn: !!nextBtn
            });
            
            if (numberSequence.length === 0) {
                display.textContent = 'No hay n√∫meros para mostrar';
                return;
            }
            
            // Calcular cu√°ntos n√∫meros mostrar en esta p√°gina seg√∫n el modo
            let numbersToShow = [];
            let numbersInThisPage = 0;
            
            if (displayMode === 'pairs') {
                // Modo parejas: mostrar 2 n√∫meros por p√°gina
                // Si estamos en la √∫ltima p√°gina y hay un n√∫mero impar, mostrar solo 1
                if (currentNumberIndex + 2 >= numberSequence.length && numberSequence.length % 2 === 1) {
                    numbersInThisPage = 1;
                } else {
                    numbersInThisPage = 2;
                }
            } else {
                // Modo individual: mostrar 1 n√∫mero por p√°gina
                numbersInThisPage = 1;
            }
            
            console.log('C√°lculos de navegaci√≥n:', {
                currentNumberIndex,
                numberSequenceLength: numberSequence.length,
                numbersInThisPage,
                displayMode,
                isLastPage: currentNumberIndex + numbersInThisPage >= numberSequence.length
            });
            
            // Obtener los n√∫meros para mostrar
            for (let i = 0; i < numbersInThisPage && currentNumberIndex + i < numberSequence.length; i++) {
                numbersToShow.push(numberSequence[currentNumberIndex + i]);
            }
            
            display.textContent = numbersToShow.join(' ');
            progress.textContent = `N√∫meros ${currentNumberIndex + 1}-${currentNumberIndex + numbersInThisPage} de ${numberSequence.length}`;
            
            // Actualizar botones de navegaci√≥n
            const prevShouldBeDisabled = currentNumberIndex === 0;
            const nextShouldBeDisabled = currentNumberIndex + numbersInThisPage >= numberSequence.length;
            
            prevBtn.disabled = prevShouldBeDisabled;
            nextBtn.disabled = nextShouldBeDisabled;
            
            console.log('Estado de botones:', {
                prevDisabled: prevShouldBeDisabled,
                nextDisabled: nextShouldBeDisabled,
                prevBtnActualDisabled: prevBtn.disabled,
                nextBtnActualDisabled: nextBtn.disabled
            });
        }

        // Navegaci√≥n
        function previousNumber() {
            console.log('=== FUNCI√ìN previousNumber() EJECUTADA ===');
            console.log('Bot√≥n Anterior clickeado. currentNumberIndex:', currentNumberIndex);
            console.log('numberSequence.length:', numberSequence.length);
            
            if (currentNumberIndex > 0) {
                // Retroceder seg√∫n el modo de visualizaci√≥n
                const stepSize = displayMode === 'pairs' ? 2 : 1;
                currentNumberIndex = Math.max(0, currentNumberIndex - stepSize);
                console.log('Nuevo currentNumberIndex:', currentNumberIndex);
                updateDisplay();
                
                // Reiniciar timer si estamos en modo autoavance
                if (currentMode === 'auto-advance') {
                    clearInterval(timerInterval);
                    timer = autoAdvanceTime;
                    document.getElementById('timer').textContent = `Tiempo restante: ${timer.toFixed(1)} segundos`;
                    document.getElementById('elapsed-time').textContent = `Tiempo empleado: 0.0 segundos`;
                    startTimer();
                }
            } else {
                console.log('No se puede retroceder m√°s - ya estamos en el inicio');
            }
        }

        function nextNumber() {
            console.log('=== FUNCI√ìN nextNumber() EJECUTADA ===');
            console.log('Bot√≥n Siguiente clickeado. currentNumberIndex:', currentNumberIndex);
            console.log('numberSequence.length:', numberSequence.length);
            
            // Calcular el paso seg√∫n el modo de visualizaci√≥n
            const stepSize = displayMode === 'pairs' ? 2 : 1;
            const canAdvance = currentNumberIndex + stepSize < numberSequence.length;
            
            console.log('Puede avanzar:', canAdvance, 'stepSize:', stepSize);
            
            if (canAdvance) {
                currentNumberIndex += stepSize;
                console.log('Nuevo currentNumberIndex:', currentNumberIndex);
                updateDisplay();
                
                // Reiniciar timer si estamos en modo autoavance
                if (currentMode === 'auto-advance') {
                    clearInterval(timerInterval);
                    timer = autoAdvanceTime;
                    document.getElementById('timer').textContent = `Tiempo restante: ${timer.toFixed(1)} segundos`;
                    document.getElementById('elapsed-time').textContent = `Tiempo empleado: 0.0 segundos`;
                    startTimer();
                }
            } else {
                console.log('No se puede avanzar m√°s - ya estamos en el final');
            }
        }

        // Timer para fase de memorizaci√≥n
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            const startTime = Date.now();
            
            timerInterval = setInterval(() => {
                timer -= 0.1;
                const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
                
                if (timer <= 0) {
                    if (currentMode === 'auto-advance') {
                        // En modo autoavance, avanzar a la siguiente p√°gina
                        advanceToNextPage();
                    } else {
                        // En modo normal, terminar memorizaci√≥n
                        finishMemorization();
                    }
                } else {
                    document.getElementById('timer').textContent = `Tiempo restante: ${timer.toFixed(1)} segundos`;
                    document.getElementById('elapsed-time').textContent = `Tiempo empleado: ${elapsedTime} segundos`;
                }
            }, 100);
        }

        // Avanzar a la siguiente p√°gina en modo autoavance
        function advanceToNextPage() {
            const stepSize = displayMode === 'pairs' ? 2 : 1;
            const totalPages = displayMode === 'pairs' ? Math.ceil(numberSequence.length / 2) : numberSequence.length;
            const currentPage = displayMode === 'pairs' ? Math.floor(currentNumberIndex / 2) + 1 : currentNumberIndex + 1;
            
            if (currentPage < totalPages) {
                // Avanzar a la siguiente p√°gina
                currentNumberIndex += stepSize;
                updateDisplay();
                
                // Reiniciar timer para la nueva p√°gina
                timer = autoAdvanceTime;
                document.getElementById('timer').textContent = `Tiempo restante: ${timer.toFixed(1)} segundos`;
                document.getElementById('elapsed-time').textContent = `Tiempo empleado: 0.0 segundos`;
                
                // Actualizar mensaje de progreso
                const memorizationInfo = document.getElementById('memorization-info');
                memorizationInfo.textContent = `P√°gina ${currentPage + 1} de ${totalPages}. Avanzar√° autom√°ticamente en ${autoAdvanceTime.toFixed(1)} segundos.`;
            } else {
                // Llegamos a la √∫ltima p√°gina, terminar memorizaci√≥n
                finishMemorization();
            }
        }

        // Terminar memorizaci√≥n manualmente
        function finishMemorization() {
            clearInterval(timerInterval);
            // Calcular tiempo real de memorizaci√≥n
            actualMemorizationTime = ((Date.now() - memorizationStartTime) / 1000).toFixed(1);
            
            gameState = 'input';
            document.getElementById('memorization-phase').classList.add('hidden');
            document.getElementById('input-phase').classList.remove('hidden');
            
            // Limpiar todos los campos antes de generar la cuadr√≠cula
            clearAllInputs();
            
            // Generar cuadr√≠cula de d√≠gitos
            generateDigitsGrid();
            
            // Agregar event listener para el input continuo
            const continuousInput = document.getElementById('continuous-input');
            if (continuousInput) {
                continuousInput.addEventListener('input', syncDigitsGrid);
            }
            
            // Configurar captura global de teclas
            window.cleanupKeyCapture = setupGlobalKeyCapture();
            
            // Iniciar timer de recall
            startRecallTimer();
            
            // 1. En finishMemorization, despu√©s de mostrar la fase de input, a√±ade:
            document.getElementById('recall-timer-display').insertAdjacentHTML('afterend', `<div id="memorization-time-info" style="font-size:1.1rem;color:#1976d2;margin:10px 0 0 0;">Tiempo de memorizaci√≥n: <b>${actualMemorizationTime}</b> segundos</div>`);
            
            // En finishMemorization, despu√©s de calcular actualMemorizationTime, guardar inmediatamente en el array:
            actualMemorizationTime = ((Date.now() - memorizationStartTime) / 1000).toFixed(1);
            // Guardar el tiempo de memorizaci√≥n para la ronda actual inmediatamente
            if (!window.roundMemTimes) window.roundMemTimes = [];
            // Asegurar que el array tenga el tama√±o correcto
            while (window.roundMemTimes.length < currentRound) {
                window.roundMemTimes.push(null);
            }
            window.roundMemTimes[currentRound - 1] = actualMemorizationTime;
            // Actualizar la progresi√≥n de rondas para mostrar el tiempo de la ronda actual
            updateProgressDisplay();
        }

        // Generar cuadr√≠cula de d√≠gitos
        function generateDigitsGrid() {
            const container = document.getElementById('digits-input-container');
            container.innerHTML = '';
            
            // Crear inputs para todos los n√∫meros en la secuencia
            for (let numberIndex = 0; numberIndex < numberSequence.length; numberIndex++) {
                // Crear contenedor para el par de d√≠gitos
                const pairContainer = document.createElement('div');
                pairContainer.className = 'number-pair';
                
                // Crear 2 inputs para los d√≠gitos del n√∫mero
                for (let digitPos = 0; digitPos < 2; digitPos++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'digit-input';
                    input.maxLength = 1;
                    input.dataset.digitIndex = (numberIndex * 2) + digitPos; // Unique index for each digit
                    input.dataset.numberIndex = numberIndex;
                    input.dataset.digitPosition = digitPos;
                    input.placeholder = '_';
                    input.value = ''; // Asegurar que est√© completamente vac√≠o
                    
                    // Evento para sincronizar con el input continuo
                    input.addEventListener('input', function(e) {
                        // Limpiar el valor anterior y establecer solo el nuevo d√≠gito
                        const value = e.target.value;
                        if (value.length > 1) {
                            // Si hay m√°s de un car√°cter, mantener solo el √∫ltimo
                            e.target.value = value.slice(-1);
                        }
                        syncContinuousInput();
                    });
                    
                    // Evento para mover al siguiente input autom√°ticamente
                    input.addEventListener('input', function(e) {
                        const value = e.target.value;
                        if (value.length === 1 && /^\d$/.test(value)) {
                            const nextInput = container.querySelector(`[data-digit-index="${(numberIndex * 2) + digitPos + 1}"]`);
                            if (nextInput) {
                                nextInput.focus();
                            }
                        }
                    });
                    
                    // Evento para permitir clic directo en cualquier d√≠gito
                    input.addEventListener('click', function(e) {
                        e.stopPropagation();
                        this.focus();
                        this.select();
                    });
                    
                    pairContainer.appendChild(input);
                }
                
                container.appendChild(pairContainer);
            }
            
            // Limpiar tambi√©n el input continuo
            const continuousInput = document.getElementById('continuous-input');
            if (continuousInput) {
                continuousInput.value = '';
                continuousInput.placeholder = 'Escribe todos los n√∫meros seguidos aqu√≠...';
            }
            
            // Asegurar que todos los campos est√©n completamente vac√≠os
            setTimeout(() => {
                const allInputs = container.querySelectorAll('.digit-input');
                allInputs.forEach(input => {
                    input.value = '';
                });
            }, 10);
        }

        // Configurar captura global de teclas
        function setupGlobalKeyCapture() {
            const totalDigits = numberSequence.length * 2;
            let currentDigitIndex = 0;
            
            function handleKeyPress(e) {
                // Alternar pantalla completa con F11
                if (e.key === 'F11') {
                    e.preventDefault();
                    toggleFullscreen();
                    return;
                }
                
                // Procesar si estamos en la fase de memorizaci√≥n o recall
                if (gameState !== 'memorization' && gameState !== 'input') return;
                
                // Navegaci√≥n en fase de memorizaci√≥n
                if (gameState === 'memorization') {
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        previousNumber();
                        return;
                    }
                    if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        nextNumber();
                        return;
                    }
                    return; // No procesar otras teclas en memorizaci√≥n
                }
                
                // Fase de recall - verificar si alg√∫n input de d√≠gito tiene el foco (edici√≥n directa)
                const focusedDigitInput = document.querySelector('.digit-input:focus');
                const focusedContinuousInput = document.querySelector('#continuous-input:focus');
                
                // Si el input continuo tiene foco, no procesar globalmente
                if (focusedContinuousInput) {
                    return;
                }
                
                // Si un input de d√≠gito tiene foco, permitir edici√≥n directa
                if (focusedDigitInput) {
                    // Para n√∫meros, permitir que el input maneje su propia edici√≥n y avanzar autom√°ticamente
                    if (/^\d$/.test(e.key)) {
                        // Reemplazar el contenido anterior con el nuevo d√≠gito
                        focusedDigitInput.value = e.key;
                        setTimeout(() => {
                            const nextInput = focusedDigitInput.parentElement.parentElement.querySelector(`[data-digit-index="${parseInt(focusedDigitInput.dataset.digitIndex) + 1}"]`);
                            if (nextInput) {
                                nextInput.focus();
                            }
                        }, 50);
                        return;
                    }
                    
                    // Para flechas, permitir navegaci√≥n entre inputs
                    if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        const nextInput = focusedDigitInput.parentElement.parentElement.querySelector(`[data-digit-index="${parseInt(focusedDigitInput.dataset.digitIndex) + 1}"]`);
                        if (nextInput) {
                            nextInput.focus();
                        }
                        return;
                    }
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        const prevInput = focusedDigitInput.parentElement.parentElement.querySelector(`[data-digit-index="${parseInt(focusedDigitInput.dataset.digitIndex) - 1}"]`);
                        if (prevInput) {
                            prevInput.focus();
                        }
                        return;
                    }
                    
                    return;
                }
                
                // Solo procesar n√∫meros si ning√∫n input de d√≠gito tiene foco (escritura continua)
                if (/^\d$/.test(e.key)) {
                    e.preventDefault();
                    
                    const inputs = document.querySelectorAll('.digit-input');
                    
                    if (currentDigitIndex < inputs.length) {
                        // Reemplazar el contenido anterior con el nuevo d√≠gito
                        inputs[currentDigitIndex].value = e.key;
                        currentDigitIndex++;
                        
                        // Sincronizar con input continuo
                        syncContinuousInput();
                    }
                }
                
                // Manejar Backspace solo si ning√∫n input tiene foco
                if (e.key === 'Backspace') {
                    e.preventDefault();
                    if (currentDigitIndex > 0) {
                        currentDigitIndex--;
                        const inputs = document.querySelectorAll('.digit-input');
                        inputs[currentDigitIndex].value = '';
                        inputs[currentDigitIndex].focus();
                        syncContinuousInput();
                    }
                }
            }
            
            // Limpiar event listeners anteriores si existen
            if (window.currentKeyCaptureHandler) {
                document.removeEventListener('keydown', window.currentKeyCaptureHandler);
            }
            
            // Guardar referencia al handler actual
            window.currentKeyCaptureHandler = handleKeyPress;
            
            // Agregar event listener global
            document.addEventListener('keydown', handleKeyPress);
            
            // Retornar funci√≥n para limpiar
            return () => {
                if (window.currentKeyCaptureHandler) {
                    document.removeEventListener('keydown', window.currentKeyCaptureHandler);
                    window.currentKeyCaptureHandler = null;
                }
            };
        }

        // Sincronizar input continuo con cuadr√≠cula de d√≠gitos
        function syncContinuousInput() {
            const continuousInput = document.getElementById('continuous-input');
            
            if (continuousInput) {
                // Recolectar todos los valores de todos los n√∫meros
                let allValues = '';
                
                for (let numberIndex = 0; numberIndex < numberSequence.length; numberIndex++) {
                    // Buscar los inputs correspondientes a este n√∫mero
                    const inputs = document.querySelectorAll(`[data-number-index="${numberIndex}"]`);
                    if (inputs.length === 2) {
                        allValues += inputs[0].value + inputs[1].value;
                    }
                }
                
                continuousInput.value = allValues;
            }
        }



        // Sincronizar cuadr√≠cula de d√≠gitos con input continuo
        function syncDigitsGrid() {
            const continuousInput = document.getElementById('continuous-input');
            
            if (continuousInput) {
                const value = continuousInput.value.replace(/\D/g, ''); // Solo n√∫meros
                const digits = value.split('');
                
                // Distribuir los d√≠gitos en todos los n√∫meros
                let digitIndex = 0;
                
                for (let numberIndex = 0; numberIndex < numberSequence.length; numberIndex++) {
                    // Buscar los inputs correspondientes a este n√∫mero
                    const inputs = document.querySelectorAll(`[data-number-index="${numberIndex}"]`);
                    if (inputs.length === 2) {
                        inputs[0].value = digits[digitIndex] || '';
                        inputs[1].value = digits[digitIndex + 1] || '';
                        digitIndex += 2;
                    }
                }
            }
        }

        // Timer para fase de recall
        function startRecallTimer() {
            let recallTimeLeft = recallTime;
            document.getElementById('recall-timer-display').textContent = `Tiempo restante: ${recallTimeLeft.toFixed(1)} segundos`;
            
            recallTimerInterval = setInterval(() => {
                recallTimeLeft--;
                document.getElementById('recall-timer-display').textContent = `Tiempo restante: ${recallTimeLeft.toFixed(1)} segundos`;
                
                if (recallTimeLeft <= 0) {
                    clearInterval(recallTimerInterval);
                    checkAnswer();
                }
            }, 1000);
        }



        // Mostrar n√∫meros de nuevo
        function showNumberAgain() {
            if (currentMode === 'auto-advance') return; // No permitir en modo autoavance
            
            document.getElementById('input-phase').classList.add('hidden');
            document.getElementById('memorization-phase').classList.remove('hidden');
            currentNumberIndex = 0;
            updateDisplay();
            timer = memorizationTime;
            document.getElementById('timer').textContent = `Tiempo restante: ${timer.toFixed(1)} segundos`;
            
            // Actualizar mensaje de memorizaci√≥n
            const memorizationInfo = document.getElementById('memorization-info');
            memorizationInfo.textContent = `Memoriza estos n√∫meros. Tienes ${memorizationTime.toFixed(1)} segundos.`;
            
            // Configurar captura global de teclas para memorizaci√≥n
            window.cleanupKeyCapture = setupGlobalKeyCapture();
            
            startTimer();
        }

                 // Verificar respuesta
         function checkAnswer() {
             // Limpiar captura global de teclas
             if (window.cleanupKeyCapture) {
                 window.cleanupKeyCapture();
                 window.cleanupKeyCapture = null;
             }
             
             // Recolectar todos los d√≠gitos de todos los n√∫meros
             let userDigits = [];
             
             for (let numberIndex = 0; numberIndex < numberSequence.length; numberIndex++) {
                 // Buscar los inputs correspondientes a este n√∫mero
                 const inputs = document.querySelectorAll(`[data-number-index="${numberIndex}"]`);
                 if (inputs.length === 2) {
                     const digit1 = inputs[0].value;
                     const digit2 = inputs[1].value;
                     userDigits.push(digit1, digit2);
                 }
             }
             
             // Convertir d√≠gitos en n√∫meros de 2 d√≠gitos
             const userNumbers = [];
             for (let i = 0; i < userDigits.length; i += 2) {
                 const number = userDigits.slice(i, i + 2).join('');
                 userNumbers.push(number);
             }
             
             // Comparar con la secuencia original
             const correct = userNumbers.length === numberSequence.length && 
                            userNumbers.every((num, index) => num === numberSequence[index]);
             
             isCorrect = correct;
             
             // Calcular precisi√≥n por d√≠gitos correctos de la ronda actual
             let correctDigits = 0;
             let totalDigits = 0;
             
             // Comparar cada d√≠gito individualmente
             for (let i = 0; i < numberSequence.length; i++) {
                 const expected = numberSequence[i];
                 const actual = userNumbers[i] || '';
                 
                 // Comparar cada d√≠gito del n√∫mero
                 for (let j = 0; j < 2; j++) {
                     totalDigits++;
                     if (expected[j] === actual[j]) {
                         correctDigits++;
                     }
                 }
             }
             
             // Calcular precisi√≥n de la ronda actual (porcentaje de d√≠gitos correctos)
             const roundAccuracy = totalDigits > 0 ? Math.round((correctDigits / totalDigits) * 100) : 0;
             
             // Debug: mostrar informaci√≥n del c√°lculo
             console.log('C√°lculo de precisi√≥n:');
             console.log('N√∫meros esperados:', numberSequence);
             console.log('N√∫meros del usuario:', userNumbers);
             console.log('D√≠gitos correctos:', correctDigits);
             console.log('Total de d√≠gitos:', totalDigits);
             console.log('Porcentaje de acierto:', roundAccuracy + '%');
             
             // Ejemplo de verificaci√≥n:
             // Si numberSequence = ["22", "33"] y userNumbers = ["22", "44"]
             // D√≠gitos esperados: 2,2,3,3
             // D√≠gitos del usuario: 2,2,4,4
             // D√≠gitos correctos: 2 (primeros dos d√≠gitos)
             // Total d√≠gitos: 4
             // Porcentaje: (2/4) * 100 = 50%
             
             // Guardar puntuaci√≥n de la ronda (1 si todos los n√∫meros son correctos, 0 si no)
             const roundScore = correct ? 1 : 0;
             roundScores.push(roundScore);
             totalScore += roundScore;
             
             // Guardar tambi√©n la precisi√≥n de d√≠gitos para esta ronda
             if (!window.roundAccuracies) window.roundAccuracies = [];
             window.roundAccuracies.push(roundAccuracy);
             
             // Calcular resultados detallados y marcar inputs
             results = userNumbers.map((num, index) => {
                 const isNumberCorrect = num === numberSequence[index];
                 
                 // Marcar los inputs correspondientes
                 const inputs = document.querySelectorAll(`[data-number-index="${index}"]`);
                 if (inputs.length === 2) {
                     inputs[0].classList.remove('correct', 'incorrect');
                     inputs[1].classList.remove('correct', 'incorrect');
                     inputs[0].classList.add(isNumberCorrect ? 'correct' : 'incorrect');
                     inputs[1].classList.add(isNumberCorrect ? 'correct' : 'incorrect');
                 }
                 
                 return {
                     expected: numberSequence[index],
                     actual: num,
                     correct: isNumberCorrect
                 };
             });
             
             // Detener timers
             if (timerInterval) clearInterval(timerInterval);
             if (recallTimerInterval) clearInterval(recallTimerInterval);
             
             document.getElementById('input-phase').classList.add('hidden');
             
             // Actualizar informaci√≥n de la ronda
             document.getElementById('current-round-display').textContent = currentRound;
             document.getElementById('round-number').textContent = currentRound;
             document.getElementById('total-rounds').textContent = totalRounds;
             
             // Actualizar barra de progreso
             const progressPercentage = (currentRound / totalRounds) * 100;
             document.getElementById('round-progress-fill').style.width = progressPercentage + '%';
             
             // Mostrar botones seg√∫n si es la √∫ltima ronda
             if (currentRound === totalRounds) {
                 document.getElementById('next-round-btn').style.display = 'none';
                 document.getElementById('new-game-btn').style.display = 'none';
                 document.getElementById('menu-btn').style.display = 'inline-block';
             } else {
                 document.getElementById('next-round-btn').style.display = 'inline-block';
                 document.getElementById('new-game-btn').style.display = 'inline-block';
                 document.getElementById('menu-btn').style.display = 'none';
             }
             
             document.getElementById('result-phase').classList.remove('hidden');
             
             const resultMessage = document.getElementById('result-message');
             
             if (correct) {
                 resultMessage.className = 'result-message correct-result';
                 resultMessage.innerHTML = '¬°Correcto! üéâ';
             } else {
                 resultMessage.className = 'result-message incorrect-result';
                 resultMessage.innerHTML = 'Incorrecto ‚ùå';
             }
             
             // A√±adir el tiempo real de memorizaci√≥n:
             resultMessage.innerHTML += `<br><span style='font-size:1.1rem;color:#1976d2;'>Tiempo de memorizaci√≥n: <b>${actualMemorizationTime}</b> segundos</span>`;
             
             // Crear comparaci√≥n visual detallada
             createVisualComparison();
             
             // Mostrar resultado individual de la ronda
             updateRoundResult(roundAccuracy);
             
             // Mostrar progresi√≥n de resultados
             updateProgressDisplay();
             
             // Configurar event listeners para la configuraci√≥n de resultados
             setupResultConfiguration();
             
             // 3. En checkAnswer, guarda el tiempo real de memorizaci√≥n en un array global por ronda:
             if (!window.roundMemTimes) window.roundMemTimes = [];
             window.roundMemTimes.push(actualMemorizationTime);
         }

                 // Funci√≥n para pasar a la siguiente ronda
         function nextRound() {
             currentRound++;
             
             if (currentRound > totalRounds) {
                 // Mostrar resultados finales
                 showFinalResults();
             } else {
                 // Iniciar nueva ronda
                 startNewRound();
             }
         }
         
                 // Funciones de navegaci√≥n del men√∫
        function showMainMenu() {
            hideAllPhases();
            document.getElementById('main-menu').classList.remove('hidden');
            resetOnlineGame();
        }
        
        function showLocalGame() {
            hideAllPhases();
            document.getElementById('setup-phase').classList.remove('hidden');
            isOnlineGame = false;
        }
        
        function showOnlineMenu() {
            hideAllPhases();
            document.getElementById('online-menu').classList.remove('hidden');
        }
        
        function showJoinForm() {
            document.getElementById('join-form').classList.remove('hidden');
        }
        
        function hideAllPhases() {
            const phases = [
                'main-menu', 'online-menu', 'waiting-room', 'setup-phase',
                'memorization-phase', 'input-phase', 'result-phase', 'final-results-phase',
                'online-setup-phase', 'online-memorization-phase', 'online-input-phase',
                'online-result-phase', 'online-final-results-phase'
            ];
            
            phases.forEach(phase => {
                const element = document.getElementById(phase);
                if (element) {
                    element.classList.add('hidden');
                }
            });
        }
        
        function resetOnlineGame() {
            isOnlineGame = false;
            roomCode = '';
            playerId = '';
            isHost = false;
            opponentId = '';
            onlineGameState = 'waiting';
            onlineConfig = null;
            onlineNumberSequence = [];
            onlineCurrentNumberIndex = 0;
            onlineTimer = 0;
            onlinePlayerReady = false;
            onlineOpponentReady = false;
            onlinePlayerResults = [];
            onlineOpponentResults = [];
            
            if (roomRef) {
                roomRef.off();
            }
            if (playerRef) {
                playerRef.off();
            }
            
            updateConnectionStatus(false);
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.textContent = 'üåê Conectado';
                statusElement.className = 'connection-status connected';
                statusElement.classList.remove('hidden');
            } else {
                statusElement.textContent = '‚ùå Desconectado';
                statusElement.className = 'connection-status disconnected';
                statusElement.classList.remove('hidden');
            }
        }
        
        // Funci√≥n para ir al men√∫ principal
        function goToMenu() {
            if (isOnlineGame) {
                leaveOnlineGame();
            } else {
                resetGame();
                showMainMenu();
            }
        }
         
         // Funci√≥n para iniciar una nueva ronda
         function startNewRound() {
             gameState = 'memorization';
             currentNumberIndex = 0;
             
             // Generar nueva secuencia para la ronda
             generateNumberSequence();
             
             // Usar tiempo seg√∫n el modo seleccionado
             if (currentMode === 'auto-advance') {
                 timer = autoAdvanceTime;
             } else {
                 timer = memorizationTime;
             }
             
             // Limpiar todos los campos antes de iniciar nueva ronda
             clearAllInputs();
             
             document.getElementById('result-phase').classList.add('hidden');
             document.getElementById('memorization-phase').classList.remove('hidden');
             
             updateDisplay();
             
             // Actualizar timer inicial
             document.getElementById('timer').textContent = `Tiempo restante: ${timer.toFixed(1)} segundos`;
             
             // Actualizar mensaje de memorizaci√≥n
             const memorizationInfo = document.getElementById('memorization-info');
             if (currentMode === 'auto-advance') {
                 const totalPages = Math.ceil(numberSequence.length / 2);
                 memorizationInfo.textContent = `Ronda ${currentRound} - P√°gina 1 de ${totalPages}. Avanzar√° autom√°ticamente en ${autoAdvanceTime.toFixed(1)} segundos.`;
             } else {
                 memorizationInfo.textContent = `Ronda ${currentRound} - Memoriza estos n√∫meros. Tienes ${memorizationTime.toFixed(1)} segundos.`;
             }
             
             // Configurar captura global de teclas para memorizaci√≥n
             window.cleanupKeyCapture = setupGlobalKeyCapture();
             
             memorizationStartTime = Date.now();
             startTimer();
         }
         
         // Funci√≥n para mostrar resultados finales
         function showFinalResults() {
             document.getElementById('result-phase').classList.add('hidden');
             document.getElementById('final-results-phase').classList.remove('hidden');
             
             // Calcular estad√≠sticas finales
             const correctRounds = roundScores.filter(score => score === 1).length;
             const incorrectRounds = totalRounds - correctRounds;
             const percentage = Math.round((totalScore / totalRounds) * 100);
             
             // Calcular precisi√≥n final como promedio de las precisiones de cada ronda
             let finalAccuracy = 0;
             if (window.roundAccuracies && window.roundAccuracies.length > 0) {
                 const totalAccuracySum = window.roundAccuracies.reduce((sum, acc) => sum + acc, 0);
                 finalAccuracy = Math.round(totalAccuracySum / window.roundAccuracies.length);
             }
             
             const bestStreak = calculateBestStreak();
             
             // Actualizar gr√°ficas circulares finales
             const finalAccuracyChart = document.getElementById('final-accuracy-chart');
             const finalScoreChart = document.getElementById('final-score-chart');
             const finalStreakChart = document.getElementById('final-streak-chart');
             
             if (finalAccuracyChart) {
                 const accuracyDegrees = (finalAccuracy / 100) * 360;
                 const accuracyColor = finalAccuracy >= 80 ? '#28a745' : finalAccuracy >= 50 ? '#ffc107' : '#dc3545';
                 finalAccuracyChart.style.background = `conic-gradient(${accuracyColor} 0deg ${accuracyDegrees}deg, #e9ecef ${accuracyDegrees}deg 360deg)`;
                 finalAccuracyChart.querySelector('.pie-chart-text').textContent = finalAccuracy + '%';
             }
             
             if (finalScoreChart) {
                 // Al finalizar, el progreso debe ser 100%
                 const scoreDegrees = 360; // 100% completo
                 finalScoreChart.style.background = `conic-gradient(#007bff 0deg ${scoreDegrees}deg, #e9ecef ${scoreDegrees}deg 360deg)`;
                 finalScoreChart.querySelector('.pie-chart-text').textContent = `${totalRounds}/${totalRounds}`;
             }
             
             if (finalStreakChart) {
                 const streakPercentage = Math.min((bestStreak / totalRounds) * 100, 100);
                 const streakDegrees = (streakPercentage / 100) * 360;
                 finalStreakChart.style.background = `conic-gradient(#ffc107 0deg ${streakDegrees}deg, #e9ecef ${streakDegrees}deg 360deg)`;
                 finalStreakChart.querySelector('.pie-chart-text').textContent = bestStreak;
             }
             
             // Actualizar estad√≠sticas detalladas
             const finalTotalScore = document.getElementById('final-total-score');
             const finalScorePercentage = document.getElementById('final-score-percentage');
             const finalCorrectRounds = document.getElementById('final-correct-rounds');
             const finalBestStreak = document.getElementById('final-best-streak');
             const finalTotalRounds = document.getElementById('final-total-rounds');
             const finalTotalRounds2 = document.getElementById('final-total-rounds-2');
             
             if (finalTotalScore) {
                 finalTotalScore.textContent = totalScore;
                 finalTotalScore.className = `stat-number ${percentage >= 80 ? 'correct' : percentage >= 50 ? 'neutral' : 'incorrect'}`;
             }
             if (finalScorePercentage) {
                 finalScorePercentage.textContent = finalAccuracy + '%';
                 finalScorePercentage.className = `stat-number ${finalAccuracy >= 80 ? 'correct' : finalAccuracy >= 50 ? 'neutral' : 'incorrect'}`;
             }
             if (finalCorrectRounds) {
                 finalCorrectRounds.textContent = correctRounds;
                 finalCorrectRounds.className = `stat-number correct`;
             }
             if (finalBestStreak) {
                 finalBestStreak.textContent = bestStreak;
                 finalBestStreak.className = `stat-number ${bestStreak >= 3 ? 'correct' : bestStreak >= 1 ? 'neutral' : 'incorrect'}`;
             }
             if (finalTotalRounds) finalTotalRounds.textContent = totalRounds;
             if (finalTotalRounds2) finalTotalRounds2.textContent = totalRounds;
             
             // Generar desglose visual de rondas
             const finalRoundsBreakdown = document.getElementById('final-rounds-breakdown');
             if (finalRoundsBreakdown) {
                 finalRoundsBreakdown.innerHTML = '';
                 
                 roundScores.forEach((score, index) => {
                     const roundItem = document.createElement('div');
                     roundItem.className = `round-item ${score === 1 ? 'correct' : 'incorrect'}`;
                     roundItem.textContent = `R${index + 1}`;
                     roundItem.title = `Ronda ${index + 1}: ${score === 1 ? 'Correcto' : 'Incorrecto'}`;
                     finalRoundsBreakdown.appendChild(roundItem);
                 });
             }
             
             // Generar an√°lisis de rendimiento
             const finalPerformanceStats = document.getElementById('final-performance-stats');
             if (finalPerformanceStats) {
                 const performanceClass = percentage >= 80 ? 'correct' : percentage >= 50 ? 'neutral' : 'incorrect';
                 
                 finalPerformanceStats.innerHTML = `
                     <div class="stat-card">
                         <div class="stat-label">Precisi√≥n por D√≠gitos</div>
                         <div class="stat-number ${performanceClass}">${finalAccuracy}%</div>
                         <div style="font-size: 0.9rem; color: #666;">
                             ${finalAccuracy >= 80 ? '¬°Excelente!' : finalAccuracy >= 50 ? 'Bueno' : 'Necesita mejorar'}
                         </div>
                     </div>
                     <div class="stat-card">
                         <div class="stat-label">Rondas Perfectas</div>
                         <div class="stat-number ${percentage >= 80 ? 'correct' : percentage >= 50 ? 'neutral' : 'incorrect'}">${percentage}%</div>
                         <div style="font-size: 0.9rem; color: #666;">
                             Rondas completamente correctas
                         </div>
                     </div>
                     <p><strong>Rondas correctas:</strong> ${correctRounds} de ${totalRounds}</p>
                     <p><strong>Rondas incorrectas:</strong> ${incorrectRounds} de ${totalRounds}</p>
                     <p><strong>Mejor racha:</strong> ${bestStreak} rondas consecutivas</p>
                     <p><strong>Precisi√≥n por d√≠gitos:</strong> ${finalAccuracy}%</p>
                     <p><strong>Rondas perfectas:</strong> ${percentage}%</p>
                 `;
             }
         }
         
         // Funci√≥n para calcular la mejor racha
         function calculateBestStreak() {
             let currentStreak = 0;
             let bestStreak = 0;
             
             roundScores.forEach(score => {
                 if (score === 1) {
                     currentStreak++;
                     bestStreak = Math.max(bestStreak, currentStreak);
                 } else {
                     currentStreak = 0;
                 }
             });
             
             return bestStreak;
         }
         
         // Funci√≥n para actualizar la visualizaci√≥n de progreso
         function updateProgressDisplay() {
             const percentageList = document.getElementById('rounds-percentage-list');
             const currentScoreEl = document.getElementById('current-score');
             const currentRoundEl = document.getElementById('current-round');
             const currentPercentageEl = document.getElementById('current-percentage');
             const currentStreakEl = document.getElementById('current-streak');
             
             if (!percentageList) return;
             
             // Limpiar contenedor
             percentageList.innerHTML = '';
             
             // Crear lista simple de porcentajes por ronda
             for (let i = 1; i <= totalRounds; i++) {
                 const roundDiv = document.createElement('div');
                 roundDiv.style.cssText = 'margin: 10px 0; padding: 10px; border-radius: 8px; font-weight: bold;';
                 
                 if (i <= window.roundAccuracies.length) {
                     // Ronda completada
                     const accuracy = window.roundAccuracies[i - 1];
                     const isCorrect = accuracy === 100;
                     roundDiv.style.backgroundColor = isCorrect ? '#d4edda' : '#f8d7da';
                     roundDiv.style.color = isCorrect ? '#155724' : '#721c24';
                     roundDiv.style.border = `2px solid ${isCorrect ? '#c3e6cb' : '#f5c6cb'}`;
                     roundDiv.innerHTML = `Ronda ${i}: ${accuracy}% ${isCorrect ? '(Correcto)' : '(Incorrecto)'}<br>`;
                     // Mostrar tiempo real de memorizaci√≥n si existe
                     if (window.roundMemTimes && window.roundMemTimes[i-1]) {
                         roundDiv.innerHTML += `<span style='font-size:1rem;color:#1976d2;'>üïí ${window.roundMemTimes[i-1]} segundos</span>`;
                     }
                 } else if (i === currentRound) {
                     // Ronda actual
                     roundDiv.style.backgroundColor = '#e9ecef';
                     roundDiv.style.color = '#6c757d';
                     roundDiv.style.border = '2px solid #dee2e6';
                     roundDiv.innerHTML = `Ronda ${i}: En progreso`;
                     // Mostrar tiempo real de memorizaci√≥n si existe para la ronda actual
                     if (window.roundMemTimes && window.roundMemTimes[i-1]) {
                         roundDiv.innerHTML += `<br><span style='font-size:1rem;color:#1976d2;'>üïí ${window.roundMemTimes[i-1]} segundos</span>`;
                     }
                 } else {
                     // Ronda futura
                     roundDiv.style.backgroundColor = '#f8f9fa';
                     roundDiv.style.color = '#6c757d';
                     roundDiv.style.border = '2px solid #dee2e6';
                     roundDiv.textContent = `Ronda ${i}: Pendiente`;
                 }
                 
                 percentageList.appendChild(roundDiv);
             }
             
             // Calcular estad√≠sticas
             const completedRounds = roundScores.length;
             
             // Calcular precisi√≥n total como promedio de las precisiones de cada ronda
             let totalAccuracy = 0;
             if (window.roundAccuracies && window.roundAccuracies.length > 0) {
                 const totalAccuracySum = window.roundAccuracies.reduce((sum, acc) => sum + acc, 0);
                 totalAccuracy = Math.round(totalAccuracySum / window.roundAccuracies.length);
             }
             
             const percentage = completedRounds > 0 ? Math.round((totalScore / completedRounds) * 100) : 0;
             const bestStreak = calculateBestStreak();
             
             // Actualizar elementos de estad√≠sticas
             if (currentScoreEl) {
                 currentScoreEl.textContent = totalScore;
                 currentScoreEl.className = `stat-number ${percentage >= 80 ? 'correct' : percentage >= 50 ? 'neutral' : 'incorrect'}`;
             }
             if (currentRoundEl) currentRoundEl.textContent = currentRound;
             if (currentPercentageEl) {
                 currentPercentageEl.textContent = totalAccuracy + '%';
                 currentPercentageEl.className = `stat-number ${totalAccuracy >= 80 ? 'correct' : totalAccuracy >= 50 ? 'neutral' : 'incorrect'}`;
             }
             if (currentStreakEl) {
                 currentStreakEl.textContent = bestStreak;
                 currentStreakEl.className = `stat-number ${bestStreak >= 3 ? 'correct' : bestStreak >= 1 ? 'neutral' : 'incorrect'}`;
             }
         }
         
         // Funci√≥n para mostrar el resultado individual de cada ronda
         function updateRoundResult(roundAccuracy) {
             const roundNumber = document.getElementById('current-round-number');
             const roundAccuracyEl = document.getElementById('round-accuracy');
             const roundStatus = document.getElementById('round-status');
             
             if (roundNumber) roundNumber.textContent = currentRound;
             
             // Actualizar porcentaje de acierto
             if (roundAccuracyEl) {
                 roundAccuracyEl.textContent = roundAccuracy + '%';
                 roundAccuracyEl.className = `stat-number ${roundAccuracy === 100 ? 'correct' : 'incorrect'}`;
             }
             
             // Actualizar estado (solo Correcto o Incorrecto)
             if (roundStatus) {
                 const statusText = roundAccuracy === 100 ? 'Correcto' : 'Incorrecto';
                 const statusClass = roundAccuracy === 100 ? 'correct' : 'incorrect';
                 
                 roundStatus.textContent = statusText;
                 roundStatus.className = `stat-number ${statusClass}`;
             }
         }
         
         // Funci√≥n para ir al men√∫ principal
         function goToMenu() {
             resetGame();
         }
         
         

        // Funci√≥n para limpiar completamente todos los campos
        function clearAllInputs() {
            // Limpiar todos los inputs de d√≠gitos
            const digitInputs = document.querySelectorAll('.digit-input');
            digitInputs.forEach(input => {
                input.value = '';
                input.classList.remove('correct', 'incorrect');
            });
            
            // Limpiar input continuo
            const continuousInput = document.getElementById('continuous-input');
            if (continuousInput) {
                continuousInput.value = '';
            }
            
            // Limpiar contenedor de comparaci√≥n visual
            const comparisonContainer = document.getElementById('visual-comparison-container');
            if (comparisonContainer) {
                comparisonContainer.innerHTML = '';
            }
            
            // Limpiar tambi√©n el contenedor de d√≠gitos
            const digitsContainer = document.getElementById('digits-input-container');
            if (digitsContainer) {
                digitsContainer.innerHTML = '';
            }
        }

        // Reiniciar juego
        function resetGame() {
            gameState = 'setup';
            userInput = '';
            isCorrect = null;
            timer = 0;
            autoAdvanceTimer = 0;
            currentNumberIndex = 0;
            numberSequence = [];
            results = [];
            
                         // Reiniciar variables de rondas
             currentRound = 1;
             roundScores = [];
             totalScore = 0;
             
             // Limpiar precisiones de rondas
             if (window.roundAccuracies) {
                 window.roundAccuracies = [];
             }
            
            // Limpiar captura global de teclas
            if (window.cleanupKeyCapture) {
                window.cleanupKeyCapture();
                window.cleanupKeyCapture = null;
            }
            
            // Limpiar todos los campos
            clearAllInputs();
            
                         // Limpiar progresi√≥n de resultados
             const progressContainer = document.getElementById('rounds-progress-display');
             if (progressContainer) {
                 progressContainer.innerHTML = '';
             }
             
             // Limpiar resultado de la ronda
             const roundAccuracy = document.getElementById('round-accuracy');
             
             if (roundAccuracy) {
                 roundAccuracy.textContent = '0%';
                 roundAccuracy.className = 'stat-number neutral';
             }
             
             // Limpiar lista de porcentajes
             const percentageList = document.getElementById('rounds-percentage-list');
             if (percentageList) {
                 percentageList.innerHTML = '';
             }
            
            document.getElementById('result-phase').classList.add('hidden');
            document.getElementById('final-results-phase').classList.add('hidden');
            document.getElementById('setup-phase').classList.remove('hidden');
            
            // Mostrar men√∫ principal en lugar de setup directamente
            showMainMenu();
            
            if (timerInterval) clearInterval(timerInterval);
            if (recallTimerInterval) clearInterval(recallTimerInterval);
        }

                 // Funci√≥n para configurar la configuraci√≥n en la fase de resultados
         function setupResultConfiguration() {
             // Establecer valores actuales en los campos de configuraci√≥n
             const resultMemorizationTimer = document.getElementById('result-memorization-timer');
             const resultAutoAdvanceTime = document.getElementById('result-auto-advance-time');
             const resultMemorizationMode = document.getElementById('result-memorization-mode');
             const resultAutoAdvanceMode = document.getElementById('result-auto-advance-mode');
             
             if (resultMemorizationTimer) {
                 resultMemorizationTimer.value = memorizationTime;
             }
             if (resultAutoAdvanceTime) {
                 resultAutoAdvanceTime.value = autoAdvanceTime;
             }
             
             // Configurar modo actual
             if (currentMode === 'memorization') {
                 if (resultMemorizationMode) resultMemorizationMode.checked = true;
                 if (resultAutoAdvanceMode) resultAutoAdvanceMode.checked = false;
             } else {
                 if (resultMemorizationMode) resultMemorizationMode.checked = false;
                 if (resultAutoAdvanceMode) resultAutoAdvanceMode.checked = true;
             }
             
                              // Event listeners para configuraci√≥n de resultados
                 if (resultMemorizationTimer) {
                     resultMemorizationTimer.addEventListener('input', function() {
                         if (this.value === '') {
                             memorizationTime = 0;
                             updateResultModeDescription();
                             return;
                         }
                         
                         memorizationTime = parseFloat(this.value) || 0;
                         updateResultModeDescription();
                         
                         // Mostrar conversi√≥n de tiempo
                         const conversionDiv = document.getElementById('result-memorization-time-conversion');
                         if (memorizationTime > 60) {
                             conversionDiv.textContent = `(${formatTimeDisplay(memorizationTime)})`;
                             conversionDiv.style.display = 'block';
                         } else {
                             conversionDiv.style.display = 'none';
                         }
                     });
                 }
             
                              if (resultAutoAdvanceTime) {
                     resultAutoAdvanceTime.addEventListener('input', function() {
                         if (this.value === '') {
                             autoAdvanceTime = 0;
                             updateResultModeDescription();
                             return;
                         }
                         
                         autoAdvanceTime = parseFloat(this.value) || 0;
                         updateResultModeDescription();
                     });
                 }
             
             if (resultMemorizationMode) {
                 resultMemorizationMode.addEventListener('change', function() {
                     if (this.checked) {
                         currentMode = 'memorization';
                         updateResultModeDescription();
                     }
                 });
             }
             
             if (resultAutoAdvanceMode) {
                 resultAutoAdvanceMode.addEventListener('change', function() {
                     if (this.checked) {
                         currentMode = 'auto-advance';
                         updateResultModeDescription();
                     }
                 });
             }
             
             // Actualizar descripci√≥n inicial
             updateResultModeDescription();
         }
         
         // Funci√≥n para actualizar descripci√≥n del modo en resultados
         function updateResultModeDescription() {
             const description = document.getElementById('result-mode-description');
             if (currentMode === 'memorization') {
                 description.textContent = `El juego usar√° el tiempo de memorizaci√≥n configurado (${memorizationTime.toFixed(1)} segundos).`;
             } else {
                 const pages = Math.ceil(selectedDigits / 2);
                 const totalTime = pages * autoAdvanceTime;
                 description.textContent = `El juego avanzar√° autom√°ticamente cada ${autoAdvanceTime.toFixed(1)} segundos por p√°gina (${totalTime.toFixed(1)} segundos total).`;
             }
         }

         // Funci√≥n para crear comparaci√≥n visual detallada
         function createVisualComparison() {
            const container = document.getElementById('visual-comparison-container');
            container.innerHTML = '';
            
            const numbersPerRow = 5; // 5 n√∫meros = 10 d√≠gitos por fila
            const totalNumbers = results.length;
            const totalRows = Math.ceil(totalNumbers / numbersPerRow);
            
            // Crear filas alternadas: correcto, usuario, correcto, usuario...
            for (let rowIndex = 0; rowIndex < totalRows; rowIndex++) {
                // Fila de n√∫meros correctos
                const correctRow = document.createElement('div');
                correctRow.className = 'comparison-row';
                
                                 const correctLabel = document.createElement('div');
                 correctLabel.className = 'comparison-label';
                 correctLabel.textContent = 'Correcto:';
                 correctLabel.style.width = '100px';
                 correctRow.appendChild(correctLabel);
                
                const correctNumbers = document.createElement('div');
                correctNumbers.className = 'comparison-number';
                
                // Procesar n√∫meros para esta fila
                const startIndex = rowIndex * numbersPerRow;
                const endIndex = Math.min(startIndex + numbersPerRow, totalNumbers);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const result = results[i];
                    const correctNumber = numberSequence[i];
                    const userNumber = result.actual;
                    
                    // Comparar primer d√≠gito
                    const digit1 = document.createElement('div');
                    const isDigit1Correct = userNumber[0] === correctNumber[0];
                    digit1.className = `comparison-digit ${isDigit1Correct ? 'correct' : 'incorrect'}`;
                    digit1.textContent = correctNumber[0];
                    
                    // Comparar segundo d√≠gito
                    const digit2 = document.createElement('div');
                    const isDigit2Correct = userNumber[1] === correctNumber[1];
                    digit2.className = `comparison-digit ${isDigit2Correct ? 'correct' : 'incorrect'}`;
                    digit2.textContent = correctNumber[1];
                    
                    correctNumbers.appendChild(digit1);
                    correctNumbers.appendChild(digit2);
                }
                
                correctRow.appendChild(correctNumbers);
                container.appendChild(correctRow);
                
                // Fila de respuesta del usuario (justo debajo)
                const userRow = document.createElement('div');
                userRow.className = 'comparison-row';
                
                                 const userLabel = document.createElement('div');
                 userLabel.className = 'comparison-label';
                 userLabel.textContent = 'Tu respuesta:';
                 userLabel.style.width = '100px';
                 userRow.appendChild(userLabel);
                
                const userNumbers = document.createElement('div');
                userNumbers.className = 'comparison-number';
                
                // Procesar los mismos n√∫meros para esta fila
                for (let i = startIndex; i < endIndex; i++) {
                    const result = results[i];
                    const correctNumber = numberSequence[i];
                    const userNumber = result.actual;
                    
                    // Comparar primer d√≠gito
                    const digit1 = document.createElement('div');
                    const isDigit1Correct = userNumber[0] === correctNumber[0];
                    digit1.className = `comparison-digit ${isDigit1Correct ? 'correct' : 'incorrect'}`;
                    digit1.textContent = userNumber[0] || '_';
                    
                    // Comparar segundo d√≠gito
                    const digit2 = document.createElement('div');
                    const isDigit2Correct = userNumber[1] === correctNumber[1];
                    digit2.className = `comparison-digit ${isDigit2Correct ? 'correct' : 'incorrect'}`;
                    digit2.textContent = userNumber[1] || '_';
                    
                    userNumbers.appendChild(digit1);
                    userNumbers.appendChild(digit2);
                }
                
                userRow.appendChild(userNumbers);
                container.appendChild(userRow);
            }
        }

        // Funci√≥n para alternar pantalla completa
        function toggleFullscreen() {
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            
            if (!document.fullscreenElement) {
                // Entrar en pantalla completa
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }
                
                fullscreenBtn.textContent = '‚õ∂';
                fullscreenBtn.title = 'Salir Pantalla Completa';
                fullscreenBtn.classList.add('fullscreen');
            } else {
                // Salir de pantalla completa
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                fullscreenBtn.textContent = '‚õ∂';
                fullscreenBtn.title = 'Pantalla Completa';
                fullscreenBtn.classList.remove('fullscreen');
            }
        }
        
        // Event listener para detectar cambios en pantalla completa
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('msfullscreenchange', updateFullscreenButton);
        
        // Funci√≥n para actualizar el bot√≥n seg√∫n el estado de pantalla completa
        function updateFullscreenButton() {
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            
            if (document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
                fullscreenBtn.textContent = '‚õ∂';
                fullscreenBtn.title = 'Salir Pantalla Completa';
                fullscreenBtn.classList.add('fullscreen');
            } else {
                fullscreenBtn.textContent = '‚õ∂';
                fullscreenBtn.title = 'Pantalla Completa';
                fullscreenBtn.classList.remove('fullscreen');
            }
        }
        
        // Configurar input continuo y limpiar campos al cargar
        document.addEventListener('DOMContentLoaded', function() {
            const continuousInput = document.getElementById('continuous-input');
            if (continuousInput) {
                continuousInput.addEventListener('input', function() {
                    syncDigitsGrid();
                });
            }
            
            // Limpiar todos los campos al cargar la p√°gina
            clearAllInputs();
            
            // No establecer autom√°ticamente el valor por defecto para permitir que el usuario lo borre
            const digitsInput = document.getElementById('digits-input');
            if (digitsInput && (!digitsInput.value || digitsInput.value === '')) {
                // No establecer valor autom√°ticamente, solo actualizar la informaci√≥n
                selectedDigits = 5;
                const pages = Math.ceil(selectedDigits / 2);
                document.getElementById('selected-info').textContent = `Memorizar√°s ${selectedDigits} n√∫meros del 00-99 (${pages} p√°ginas)`;
                updateSummary();
                updateModeDescription();
                updateDisplayInfo();
            }
            
            // No establecer autom√°ticamente valores por defecto para permitir que el usuario los borre
            const memorizationTimer = document.getElementById('memorization-timer');
            if (memorizationTimer && (!memorizationTimer.value || memorizationTimer.value === '')) {
                // No establecer valor autom√°ticamente, solo actualizar la informaci√≥n
                memorizationTime = 15;
                updateSummary();
                updateModeDescription();
            }
            
            const recallTimer = document.getElementById('recall-timer');
            if (recallTimer && (!recallTimer.value || recallTimer.value === '')) {
                // No establecer valor autom√°ticamente, solo actualizar la informaci√≥n
                recallTime = 30;
                updateSummary();
                updateModeDescription();
            }
            
            const autoAdvanceTimeEl2 = document.getElementById('auto-advance-time');
            if (autoAdvanceTimeEl2 && (!autoAdvanceTimeEl2.value || autoAdvanceTimeEl2.value === '')) {
                // No establecer valor autom√°ticamente, solo actualizar la informaci√≥n
                autoAdvanceTime = 3;
                updateSummary();
                updateModeDescription();
            }
            
            // Configurar valor por defecto para rondas
            const roundsInput = document.getElementById('rounds-input');
            if (roundsInput && (!roundsInput.value || roundsInput.value === '')) {
                // No establecer valor autom√°ticamente, solo actualizar la informaci√≥n
                totalRounds = 10;
                document.getElementById('rounds-info').textContent = `Jugar√°s ${totalRounds} rondas en total`;
                updateSummary();
            }
            
            // Asegurar que el modo de memorizaci√≥n est√© seleccionado por defecto
            const memorizationMode = document.getElementById('memorization-mode');
            if (memorizationMode) {
                memorizationMode.checked = true;
            }
            
            // Event listeners para establecer valores por defecto cuando los campos est√©n vac√≠os
            const memorizationTimerEl = document.getElementById('memorization-timer');
            if (memorizationTimerEl) {
                memorizationTimerEl.addEventListener('blur', function() {
                    if (!this.value || this.value === '') {
                        this.value = '15';
                        memorizationTime = 15;
                        updateSummary();
                        updateModeDescription();
                    }
                });
                
                // Permitir borrar completamente el campo
                memorizationTimerEl.addEventListener('input', function() {
                    if (this.value === '') {
                        memorizationTime = 0;
                        updateSummary();
                        updateModeDescription();
                        return;
                    }
                    
                    memorizationTime = parseFloat(this.value) || 0;
                    updateSummary();
                    updateModeDescription();
                    
                    // Mostrar conversi√≥n de tiempo
                    const conversionDiv = document.getElementById('memorization-time-conversion');
                    if (memorizationTime > 60) {
                        conversionDiv.textContent = `(${formatTimeDisplay(memorizationTime)})`;
                        conversionDiv.style.display = 'block';
                    } else {
                        conversionDiv.style.display = 'none';
                    }
                });
            }
            
            const recallTimerEl = document.getElementById('recall-timer');
            if (recallTimerEl) {
                recallTimerEl.addEventListener('blur', function() {
                    if (!this.value || this.value === '') {
                        this.value = '30';
                        recallTime = 30;
                        updateSummary();
                        updateModeDescription();
                    }
                });
                
                // Permitir borrar completamente el campo
                recallTimerEl.addEventListener('input', function() {
                    if (this.value === '') {
                        recallTime = 0;
                        updateSummary();
                        updateModeDescription();
                        return;
                    }
                    
                    recallTime = parseFloat(this.value) || 0;
                    updateSummary();
                    updateModeDescription();
                    
                    // Mostrar conversi√≥n de tiempo
                    const conversionDiv = document.getElementById('recall-time-conversion');
                    if (recallTime > 60) {
                        conversionDiv.textContent = `(${formatTimeDisplay(recallTime)})`;
                        conversionDiv.style.display = 'block';
                    } else {
                        conversionDiv.style.display = 'none';
                    }
                });
            }
            
            const autoAdvanceTimeEl = document.getElementById('auto-advance-time');
            if (autoAdvanceTimeEl) {
                autoAdvanceTimeEl.addEventListener('blur', function() {
                    if (!this.value || this.value === '') {
                        this.value = '3';
                        autoAdvanceTime = 3;
                        updateSummary();
                        updateModeDescription();
                    }
                });
                
                // Permitir borrar completamente el campo
                autoAdvanceTimeEl.addEventListener('input', function() {
                    if (this.value === '') {
                        autoAdvanceTime = 0;
                        updateSummary();
                        updateModeDescription();
                        return;
                    }
                    
                    autoAdvanceTime = parseFloat(this.value) || 0;
                    updateSummary();
                    updateModeDescription();
                });
            }
            
            // Actualizar resumen y descripci√≥n inicial
            updateSummary();
            updateModeDescription();
            

            
            // Funci√≥n para validar si se puede comenzar el juego
            function validateGameStart() {
                const digitsInput = document.getElementById('digits-input');
                const memorizationTimer = document.getElementById('memorization-timer');
                const recallTimer = document.getElementById('recall-timer');
                const autoAdvanceTimeInput = document.getElementById('auto-advance-time');
                const roundsInput = document.getElementById('rounds-input');
                const startButton = document.querySelector('button[onclick="startGame()"]');
                
                // Verificar si los campos tienen valores v√°lidos
                const hasDigits = selectedDigits > 0;
                const hasRounds = totalRounds > 0;
                const hasRecallTime = recallTime > 0;
                
                let hasTimeMode = false;
                if (currentMode === 'memorization') {
                    hasTimeMode = memorizationTime > 0;
                } else {
                    hasTimeMode = autoAdvanceTime > 0;
                }
                
                const canStart = hasDigits && hasRounds && hasRecallTime && hasTimeMode;
                
                if (startButton) {
                    startButton.disabled = !canStart;
                    if (canStart) {
                        startButton.style.opacity = '1';
                        startButton.style.cursor = 'pointer';
                    } else {
                        startButton.style.opacity = '0.6';
                        startButton.style.cursor = 'not-allowed';
                    }
                }
            }
            
            // Llamar a la validaci√≥n inicial
            validateGameStart();
            
            // A√±adir event listeners para validaci√≥n en tiempo real
            const digitsInputEl2 = document.getElementById('digits-input');
            const memorizationTimerEl2 = document.getElementById('memorization-timer');
            const recallTimerEl2 = document.getElementById('recall-timer');
            const autoAdvanceTimeInputEl2 = document.getElementById('auto-advance-time');
            const roundsInputEl2 = document.getElementById('rounds-input');
            
            if (digitsInputEl2) {
                digitsInputEl2.addEventListener('input', validateGameStart);
            }
            if (memorizationTimerEl2) {
                memorizationTimerEl2.addEventListener('input', validateGameStart);
            }
            if (recallTimerEl2) {
                recallTimerEl2.addEventListener('input', validateGameStart);
            }
            if (autoAdvanceTimeInputEl2) {
                autoAdvanceTimeInputEl2.addEventListener('input', validateGameStart);
            }
            if (roundsInputEl2) {
                roundsInputEl2.addEventListener('input', validateGameStart);
            }
            
            // Validar tambi√©n cuando cambie el modo
            const memorizationModeEl = document.getElementById('memorization-mode');
            const autoAdvanceModeEl = document.getElementById('auto-advance-mode');
            
            if (memorizationModeEl) {
                memorizationModeEl.addEventListener('change', validateGameStart);
            }
            if (autoAdvanceModeEl) {
                autoAdvanceModeEl.addEventListener('change', validateGameStart);
            }
            
            // Inicializar sistema de simulaci√≥n
            updateConnectionStatus(true);
        });
        
        // Funciones para juego online
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function createOnlineGame() {
            roomCode = generateRoomCode();
            playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            isHost = true;
            
            // Crear sala en simulaci√≥n
            roomRef = db.ref(`rooms/${roomCode}`);
            playerRef = roomRef.child(`players/${playerId}`);
            
            const roomData = {
                host: playerId,
                status: 'waiting',
                createdAt: Date.now(),
                config: null,
                currentRound: 1,
                totalRounds: 10,
                gameState: 'waiting',
                players: {}
            };
            
            const playerData = {
                id: playerId,
                name: 'Anfitri√≥n',
                ready: false,
                isHost: true,
                joinedAt: Date.now()
            };
            
            roomData.players[playerId] = playerData;
            
            roomRef.set(roomData);
            
            // Escuchar cambios en la sala
            roomRef.on('value', handleRoomUpdate);
            
            // Mostrar sala de espera
            hideAllPhases();
            document.getElementById('waiting-room').classList.remove('hidden');
            document.getElementById('room-code-display').textContent = roomCode;
            
            updateConnectionStatus(true);
            
            // Simular que un jugador se une despu√©s de 3 segundos (para pruebas)
            setTimeout(() => {
                if (isHost && roomCode) {
                    const guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const guestData = {
                        id: guestId,
                        name: 'Invitado',
                        ready: false,
                        isHost: false,
                        joinedAt: Date.now()
                    };
                    
                    const currentRoomData = JSON.parse(localStorage.getItem('firebase_rooms/' + roomCode) || '{}');
                    currentRoomData.players = currentRoomData.players || {};
                    currentRoomData.players[guestId] = guestData;
                    localStorage.setItem('firebase_rooms/' + roomCode, JSON.stringify(currentRoomData));
                    
                    opponentId = guestId;
                    updateWaitingRoom(currentRoomData);
                }
            }, 3000);
        }
        
        function joinOnlineGame() {
            const inputCode = document.getElementById('room-code-input').value.trim().toUpperCase();
            if (!inputCode || inputCode.length !== 6) {
                alert('Por favor, ingresa un c√≥digo v√°lido de 6 caracteres.');
                return;
            }
            
            roomCode = inputCode;
            playerId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            isHost = false;
            
            // Verificar si la sala existe
            const roomData = JSON.parse(localStorage.getItem('firebase_rooms/' + roomCode) || '{}');
            
            if (Object.keys(roomData).length > 0) {
                if (roomData.status === 'waiting') {
                    // Unirse a la sala
                    const playerData = {
                        id: playerId,
                        name: 'Invitado',
                        ready: false,
                        isHost: false,
                        joinedAt: Date.now()
                    };
                    
                    roomData.players = roomData.players || {};
                    roomData.players[playerId] = playerData;
                    localStorage.setItem('firebase_rooms/' + roomCode, JSON.stringify(roomData));
                    
                    // Conectar a la sala
                    roomRef = db.ref(`rooms/${roomCode}`);
                    playerRef = roomRef.child(`players/${playerId}`);
                    
                    // Escuchar cambios
                    roomRef.on('value', handleRoomUpdate);
                    
                    // Mostrar sala de espera
                    hideAllPhases();
                    document.getElementById('waiting-room').classList.remove('hidden');
                    document.getElementById('room-code-display').textContent = roomCode;
                    
                    updateConnectionStatus(true);
                } else {
                    alert('Esta sala ya est√° en juego o ha finalizado.');
                }
            } else {
                alert('Sala no encontrada. Verifica el c√≥digo.');
            }
        }
        
        function handleRoomUpdate(snapshot) {
            if (!snapshot.exists()) return;
            
            const roomData = snapshot.val();
            onlineGameState = roomData.gameState;
            onlineConfig = roomData.config;
            onlineCurrentRound = roomData.currentRound || 1;
            onlineTotalRounds = roomData.totalRounds || 10;
            
            // Actualizar estado seg√∫n la fase del juego
            switch (onlineGameState) {
                case 'waiting':
                    updateWaitingRoom(roomData);
                    break;
                case 'setup':
                    showOnlineSetupPhase();
                    break;
                case 'memorizing':
                    showOnlineMemorizationPhase();
                    break;
                case 'writing':
                    showOnlineWritingPhase();
                    break;
                case 'results':
                    showOnlineResultsPhase();
                    break;
                case 'finished':
                    showOnlineFinalResults();
                    break;
            }
        }
        
        function updateWaitingRoom(roomData) {
            if (roomData && roomData.players) {
                const players = Object.values(roomData.players);
                const host = players.find(p => p.isHost);
                const guest = players.find(p => !p.isHost);
                
                if (host) {
                    document.getElementById('host-name').textContent = host.name;
                    document.getElementById('host-status').textContent = host.ready ? '‚úÖ Listo' : '‚è≥ Configurando...';
                }
                
                if (guest) {
                    document.getElementById('guest-name').textContent = guest.name;
                    document.getElementById('guest-status').textContent = guest.ready ? '‚úÖ Listo' : '‚è≥ Esperando...';
                }
            }
        }
        
        function leaveOnlineGame() {
            if (playerRef) {
                playerRef.remove();
            }
            if (roomRef) {
                roomRef.off();
            }
            resetOnlineGame();
            showMainMenu();
        }
        
        function setPlayerReady() {
            onlinePlayerReady = true;
            
            // Actualizar estado del jugador en la sala
            const currentRoomData = JSON.parse(localStorage.getItem('firebase_rooms/' + roomCode) || '{}');
            if (currentRoomData.players && currentRoomData.players[playerId]) {
                currentRoomData.players[playerId].ready = true;
                localStorage.setItem('firebase_rooms/' + roomCode, JSON.stringify(currentRoomData));
            }
            
            document.getElementById('online-ready-btn').disabled = true;
            document.getElementById('online-ready-btn').textContent = '‚úÖ Listo';
            
            // Simular que el oponente tambi√©n se pone listo despu√©s de 2 segundos
            setTimeout(() => {
                if (roomCode && opponentId) {
                    const roomData = JSON.parse(localStorage.getItem('firebase_rooms/' + roomCode) || '{}');
                    if (roomData.players && roomData.players[opponentId]) {
                        roomData.players[opponentId].ready = true;
                        roomData.gameState = 'setup';
                        localStorage.setItem('firebase_rooms/' + roomCode, JSON.stringify(roomData));
                        
                        // Iniciar el juego
                        startOnlineGame();
                    }
                }
            }, 2000);
        }
        
        function startOnlineGame() {
            // Configurar el juego online con valores por defecto
            onlineConfig = {
                digits: 5,
                rounds: 3,
                memorizationTime: 15,
                recallTime: 30,
                displayMode: 'pairs'
            };
            
            // Generar secuencia de n√∫meros
            generateOnlineNumberSequence();
            
            // Actualizar estado de la sala
            const roomData = JSON.parse(localStorage.getItem('firebase_rooms/' + roomCode) || '{}');
            roomData.config = onlineConfig;
            roomData.gameState = 'memorizing';
            roomData.currentRound = 1;
            localStorage.setItem('firebase_rooms/' + roomCode, JSON.stringify(roomData));
            
            showOnlineMemorizationPhase();
        }
        
        function showOnlineSetupPhase() {
            hideAllPhases();
            document.getElementById('online-setup-phase').classList.remove('hidden');
            
            // Mostrar configuraci√≥n
            if (onlineConfig) {
                displayOnlineConfig();
            }
            
            // Actualizar estado de jugadores
            updateOnlinePlayerStatus();
            
            // Habilitar bot√≥n de listo
            document.getElementById('online-ready-btn').disabled = false;
        }
        
        function displayOnlineConfig() {
            if (!onlineConfig) return;
            
            const configDiv = document.getElementById('online-config-details');
            configDiv.innerHTML = `
                <p><strong>N√∫meros:</strong> ${onlineConfig.digits}</p>
                <p><strong>Rondas:</strong> ${onlineConfig.rounds}</p>
                <p><strong>Tiempo de memorizaci√≥n:</strong> ${onlineConfig.memorizationTime}s</p>
                <p><strong>Tiempo de recall:</strong> ${onlineConfig.recallTime}s</p>
                <p><strong>Modo:</strong> ${onlineConfig.displayMode === 'pairs' ? 'Parejas' : 'Individual'}</p>
            `;
        }
        
        function updateOnlinePlayerStatus() {
            // Esta funci√≥n se implementar√° para mostrar el estado de los jugadores
        }
        
        function generateOnlineNumberSequence() {
            onlineNumberSequence = [];
            
            // Generar secuencia aleatoria de n√∫meros del 00-99
            for (let i = 0; i < onlineConfig.digits; i++) {
                const number = Math.floor(Math.random() * 100);
                onlineNumberSequence.push(number.toString().padStart(2, '0'));
            }
            
            // Guardar la secuencia en la sala para que ambos jugadores la usen
            const roomData = JSON.parse(localStorage.getItem('firebase_rooms/' + roomCode) || '{}');
            roomData.numberSequence = onlineNumberSequence;
            localStorage.setItem('firebase_rooms/' + roomCode, JSON.stringify(roomData));
        }
        
        function showOnlineMemorizationPhase() {
            hideAllPhases();
            document.getElementById('online-memorization-phase').classList.remove('hidden');
            
            // Obtener la secuencia de n√∫meros de la sala
            const roomData = JSON.parse(localStorage.getItem('firebase_rooms/' + roomCode) || '{}');
            if (roomData.numberSequence) {
                onlineNumberSequence = roomData.numberSequence;
            }
            
            // Actualizar informaci√≥n de la ronda
            document.getElementById('online-current-round').textContent = onlineCurrentRound;
            document.getElementById('online-mem-room-code').textContent = roomCode;
            
            // Mostrar los n√∫meros
            updateOnlineDisplay();
            
            // Iniciar temporizador
            startOnlineMemorizationTimer();
        }
        
        function updateOnlineDisplay() {
            const display = document.getElementById('online-number-display');
            const progress = document.getElementById('online-progress');
            const prevBtn = document.getElementById('online-prev-btn');
            const nextBtn = document.getElementById('online-next-btn');
            const pageInfo = document.getElementById('online-page-info');
            
            if (onlineNumberSequence.length === 0) {
                display.textContent = 'No hay n√∫meros para mostrar';
                return;
            }
            
            let numbersToShow = [];
            let numbersInThisPage = 0;
            
            if (onlineConfig.displayMode === 'pairs') {
                // Modo parejas: mostrar 2 n√∫meros por p√°gina
                if (onlineCurrentNumberIndex + 2 >= onlineNumberSequence.length && onlineNumberSequence.length % 2 === 1) {
                    numbersInThisPage = 1;
                } else {
                    numbersInThisPage = 2;
                }
                
                for (let i = 0; i < numbersInThisPage && onlineCurrentNumberIndex + i < onlineNumberSequence.length; i++) {
                    numbersToShow.push(onlineNumberSequence[onlineCurrentNumberIndex + i]);
                }
                
                display.textContent = numbersToShow.join(' ');
            } else {
                // Modo individual: mostrar 1 n√∫mero por p√°gina
                numbersInThisPage = 1;
                numbersToShow.push(onlineNumberSequence[onlineCurrentNumberIndex]);
                display.textContent = numbersToShow[0];
            }
            
            const totalPages = onlineConfig.displayMode === 'pairs' ? 
                Math.ceil(onlineNumberSequence.length / 2) : onlineNumberSequence.length;
            const currentPage = onlineConfig.displayMode === 'pairs' ? 
                Math.floor(onlineCurrentNumberIndex / 2) + 1 : onlineCurrentNumberIndex + 1;
            
            progress.textContent = `N√∫mero ${onlineCurrentNumberIndex + 1}-${onlineCurrentNumberIndex + numbersInThisPage} de ${onlineNumberSequence.length}`;
            pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
            
            const prevShouldBeDisabled = onlineCurrentNumberIndex === 0;
            const nextShouldBeDisabled = onlineCurrentNumberIndex + numbersInThisPage >= onlineNumberSequence.length;
            
            prevBtn.disabled = prevShouldBeDisabled;
            nextBtn.disabled = nextShouldBeDisabled;
        }
        
        function startOnlineMemorizationTimer() {
            onlineTimer = onlineConfig.memorizationTime;
            onlineMemorizationStartTime = Date.now();
            
            document.getElementById('online-timer').textContent = `Tiempo restante: ${onlineTimer.toFixed(1)} segundos`;
            
            onlineTimerInterval = setInterval(() => {
                onlineTimer -= 0.1;
                const elapsedTime = ((Date.now() - onlineMemorizationStartTime) / 1000).toFixed(1);
                document.getElementById('online-timer').textContent = `Tiempo restante: ${onlineTimer.toFixed(1)} segundos`;
                document.getElementById('online-elapsed-time').textContent = `Tiempo empleado: ${elapsedTime} segundos`;
                
                if (onlineTimer <= 0) {
                    clearInterval(onlineTimerInterval);
                    finishOnlineMemorization();
                }
            }, 100);
        }
        
        function finishOnlineMemorization() {
            clearInterval(onlineTimerInterval);
            
            // Calcular tiempo real de memorizaci√≥n
            onlineActualMemorizationTime = ((Date.now() - onlineMemorizationStartTime) / 1000).toFixed(1);
            
            // Cambiar a fase de escritura
            const roomData = JSON.parse(localStorage.getItem('firebase_rooms/' + roomCode) || '{}');
            roomData.gameState = 'writing';
            localStorage.setItem('firebase_rooms/' + roomCode, JSON.stringify(roomData));
            
            showOnlineWritingPhase();
        }
        
        // Funciones auxiliares para navegaci√≥n online
        function onlinePreviousNumber() {
            if (onlineCurrentNumberIndex > 0) {
                onlineCurrentNumberIndex = onlineConfig.displayMode === 'pairs' ? 
                    Math.max(0, onlineCurrentNumberIndex - 2) : onlineCurrentNumberIndex - 1;
                updateOnlineDisplay();
            }
        }
        
        function onlineNextNumber() {
            const increment = onlineConfig.displayMode === 'pairs' ? 2 : 1;
            if (onlineCurrentNumberIndex + increment < onlineNumberSequence.length) {
                onlineCurrentNumberIndex += increment;
                updateOnlineDisplay();
            }
        }
        
        function showOnlineWritingPhase() {
            hideAllPhases();
            document.getElementById('online-input-phase').classList.remove('hidden');
            
            // Generar grid de inputs
            generateOnlineDigitsGrid();
            
            // Iniciar temporizador de recall
            startOnlineRecallTimer();
        }
        
        function generateOnlineDigitsGrid() {
            // Implementar grid de inputs para online
        }
        
        function startOnlineRecallTimer() {
            // Implementar temporizador de recall online
        }
        
        function showOnlineResultsPhase() {
            hideAllPhases();
            document.getElementById('online-result-phase').classList.remove('hidden');
            
            // Mostrar resultados comparativos
            displayOnlineResults();
        }
        
        function displayOnlineResults() {
            // Implementar visualizaci√≥n de resultados online
        }
        
        function showOnlineFinalResults() {
            hideAllPhases();
            document.getElementById('online-final-results-phase').classList.remove('hidden');
            
            // Mostrar resultados finales
            displayOnlineFinalResults();
        }
        
        function displayOnlineFinalResults() {
            // Implementar visualizaci√≥n de resultados finales online
        }
        
        function onlineCheckAnswer() {
            // Implementar verificaci√≥n de respuesta para online
        }
        
        function onlineNextRound() {
            // Implementar siguiente ronda para online
        }
    </script>
</body>
</html> 